<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Scanner – Teachable Machine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--panel:#0f1630;--muted:#95a0b6;--accent:#6aa8ff;--accent2:#9b8cff;--ok:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1020,#111a3a);color:#e6ebff}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:linear-gradient(180deg,#0f1630,#0c1226);border:1px solid #1e2650;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{padding:18px;border-radius:16px}
    .panel + .panel{margin-top:0}
    #webcam-wrap{position:relative;display:flex;align-items:center;justify-content:center;min-height:260px;border:1px dashed #2a356a;border-radius:16px}
    #webcam-wrap canvas{border-radius:12px}
    .controls{display:flex;flex-wrap:wrap;gap:10px}
    .btn{appearance:none;border:1px solid #2a356a;background:#151e42;color:#e6ebff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:.15s;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:hover{transform:translateY(-1px);border-color:#3a4aa8}
    .btn.primary{background:linear-gradient(135deg,#1c2a77,#2438a8);border-color:#4658c9}
    .btn.danger{background:linear-gradient(135deg,#3a1b2a,#6d223a);border-color:#9b2c4a}
    .switch{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .kpi{display:flex;gap:14px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .kpi .pill{padding:6px 10px;border:1px solid #26326b;border-radius:999px}
    .pred-list{display:flex;flex-direction:column;gap:10px}
    .pred{background:#0e1531;border:1px solid #1f2a63;border-radius:12px;padding:10px 12px}
    .pred-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .bar{height:8px;background:#141c3f;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .12s ease}
    .top{font-size:28px;font-weight:800;letter-spacing:.3px}
    .muted{color:var(--muted)}
    .footer{margin-top:18px;font-size:11px;color:var(--muted)}
    .blink{animation:blink 1s infinite}@keyframes blink{50%{opacity:.4}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Live Scanner – Teachable Machine</div>
        <div class="subtitle">Non‑stop klasifikasi dari kamera — dengan kontrol Start/Stop, FPS limit, dan threshold.</div>
      </div>
      <div class="kpi">
        <div class="pill">Model: <span id="model-name">(belum dimuat)</span></div>
        <div class="pill">Kelas: <span id="class-count">0</span></div>
        <div class="pill">FPS: <span id="fps">0</span></div>
      </div>
    </header>

    <div class="grid">
      <div class="card panel">
        <div class="controls" style="margin-bottom:12px">
          <button class="btn primary" id="btn-start">Start</button>
          <button class="btn danger" id="btn-stop" disabled>Stop</button>
          <label class="switch"><input type="checkbox" id="flip" checked> Mirror</label>
          <label class="switch">Threshold: <input id="thresh" type="range" min="0" max="100" value="0"> <span id="threshVal">0%</span></label>
          <label class="switch">FPS Max: <input id="fpsLimit" type="number" min="1" max="60" value="30" style="width:64px"> </label>
        </div>

        <div id="webcam-wrap">
          <div id="loading" class="muted blink">Menyiapkan kamera & model…</div>
        </div>

        <div class="footer">
          Tip: ubah <code>Threshold</code> untuk menyorot prediksi di atas ambang batas. Gunakan <code>Mirror</code> agar tampilan seperti cermin.
        </div>
      </div>

      <div class="card panel">
        <div class="top" id="top-class">—</div>
        <div class="muted" id="top-score">Skor: —</div>
        <hr style="border:0;border-top:1px solid #253064;margin:14px 0">
        <div class="pred-list" id="predictions"></div>
      </div>
    </div>
  </div>

  <!-- TFJS & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // ====== KONFIGURASI ======
    const TM_URL = "https://teachablemachine.withgoogle.com/models/_qTkS5wpx/"; // ganti jika perlu

    // ====== STATE ======
    let model, webcam, maxPredictions = 0;
    let rafId = null, running = false;
    let lastTick = 0; // untuk batasi FPS
    let fpsCounter = { frames: 0, last: performance.now() };

    // ====== DOM ======
    const el = {
      wrap: document.getElementById('webcam-wrap'),
      loading: document.getElementById('loading'),
      preds: document.getElementById('predictions'),
      topClass: document.getElementById('top-class'),
      topScore: document.getElementById('top-score'),
      modelName: document.getElementById('model-name'),
      classCount: document.getElementById('class-count'),
      fps: document.getElementById('fps'),
      btnStart: document.getElementById('btn-start'),
      btnStop: document.getElementById('btn-stop'),
      flip: document.getElementById('flip'),
      thresh: document.getElementById('thresh'),
      threshVal: document.getElementById('threshVal'),
      fpsLimit: document.getElementById('fpsLimit'),
    };

    el.thresh.addEventListener('input', () => el.threshVal.textContent = el.thresh.value + '%');

    el.btnStart.addEventListener('click', () => start().catch(showError));
    el.btnStop.addEventListener('click', () => stop());

    async function start(){
      if(running) return;
      el.btnStart.disabled = true;
      el.btnStop.disabled = false;
      el.loading.style.display = 'block';

      // siapkan model bila belum
      if(!model){
        const modelURL = TM_URL + 'model.json';
        const metadataURL = TM_URL + 'metadata.json';
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        el.modelName.textContent = (model?.modelName) || 'Teachable Machine Model';
        el.classCount.textContent = String(maxPredictions);
        buildPredictionList(maxPredictions);
      }

      // siapkan webcam
      const flip = el.flip.checked;
      if(!webcam){
        webcam = new tmImage.Webcam(300, 300, flip);
        await webcam.setup({ facingMode: 'environment' }).catch(async () => {
          // fallback ke default jika environment gagal
          await webcam.setup();
        });
        await webcam.play();
        el.wrap.innerHTML = '';
        el.wrap.appendChild(webcam.canvas);
      } else {
        // update mirror setting
        webcam.flip = flip;
        await webcam.play();
      }

      running = true;
      el.loading.style.display = 'none';
      lastTick = 0; fpsCounter = { frames:0, last: performance.now() };
      loop(); // mulai live loop non-stop
    }

    function stop(){
      running = false;
      el.btnStart.disabled = false;
      el.btnStop.disabled = true;
      if(rafId) cancelAnimationFrame(rafId);
      if(webcam) webcam.stop();
    }

    function loop(now){
      if(!running) return;
      const limit = Math.max(1, Math.min(60, Number(el.fpsLimit.value)||30));
      const minDelta = 1000/limit;
      if(!lastTick || (now - lastTick) >= minDelta){
        lastTick = now;
        webcam.update();
        predict();
        // hitung FPS realtime (approx.)
        fpsCounter.frames++;
        const t = performance.now();
        if(t - fpsCounter.last >= 1000){
          el.fps.textContent = String(fpsCounter.frames);
          fpsCounter.frames = 0;
          fpsCounter.last = t;
        }
      }
      rafId = requestAnimationFrame(loop);
    }

    async function predict(){
      if(!model || !webcam) return;
      const results = await model.predict(webcam.canvas);
      // urutkan dari skor tertinggi
      results.sort((a,b) => b.probability - a.probability);

      const top = results[0];
      el.topClass.textContent = top.className;
      el.topScore.textContent = 'Skor: ' + (top.probability*100).toFixed(2) + '%';

      const threshold = Number(el.thresh.value)/100;
      // render list
      for(let i=0;i<results.length;i++){
        const row = document.getElementById('pred-'+i);
        const name = row.querySelector('.name');
        const score = row.querySelector('.score');
        const bar = row.querySelector('.bar > span');
        const r = results[i];
        const pct = (r.probability*100).toFixed(2);
        name.textContent = r.className;
        score.textContent = pct + '%';
        bar.style.width = pct + '%';
        row.style.borderColor = (r.probability >= threshold) ? '#2f855a' : '#1f2a63';
      }
    }

    function buildPredictionList(n){
      el.preds.innerHTML = '';
      for(let i=0;i<n;i++){
        const item = document.createElement('div');
        item.className = 'pred';
        item.id = 'pred-' + i;
        item.innerHTML = `
          <div class="pred-head">
            <div class="name">Kelas ${i+1}</div>
            <div class="score">0%</div>
          </div>
          <div class="bar"><span style="width:0%"></span></div>
        `;
        el.preds.appendChild(item);
      }
    }

    function showError(err){
      console.error(err);
      el.wrap.innerHTML = `<div class="muted">Gagal memulai kamera/model: ${err?.message || err}</div>`;
      el.btnStart.disabled = false;
      el.btnStop.disabled = true;
    }

    // Opsional: auto-start bila user sudah memberi izin kamera sebelumnya
    // document.addEventListener('DOMContentLoaded', () => start().catch(showError));
  </script>
</body>
</html>
