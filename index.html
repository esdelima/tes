<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Live Scan — Futuristic Hologram</title>
  <style>
    :root{--accent:#00fff6;--accent2:#7c4dff;--bg:#050308}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 10% 10%, rgba(124,77,255,0.06), transparent), radial-gradient(800px 400px at 90% 90%, rgba(0,255,246,0.03), transparent), var(--bg);color:#dfeaff;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    *{box-sizing:border-box}

    /* App container */
    #app{height:100vh;display:flex;flex-direction:column;align-items:stretch}

    /* camera area fills screen */
    #camera-wrap{position:relative;flex:1;overflow:hidden}
    video#video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.02) saturate(1.05) brightness(0.9)}

    /* hologram stage */
    .holo-stage{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:72vmin;height:72vmin;max-width:980px;max-height:980px;pointer-events:none;mix-blend-mode:screen}

    /* ring layers */
    .ring{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:50%;border:1px solid rgba(124,77,255,0.18);backdrop-filter:blur(2px)}
    .ring.r1{width:100%;height:100%;animation:spinSlow 12s linear infinite}
    .ring.r2{width:76%;height:76%;border-color:rgba(0,255,246,0.12);animation:spinRev 8s linear infinite}
    .ring.r3{width:36%;height:36%;border-color:rgba(124,77,255,0.25);animation:spinFast 6s linear infinite}

    @keyframes spinSlow{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(360deg)}}
    @keyframes spinRev{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(-360deg)}}
    @keyframes spinFast{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(720deg)}}

    /* scan beam */
    .scan-beam{position:absolute;left:50%;top:0;transform:translateX(-50%);width:2px;height:100%;background:linear-gradient(180deg,transparent,rgba(0,255,246,0.18),transparent);box-shadow:0 0 24px rgba(0,255,246,0.06);animation:beam 2s linear infinite}
    @keyframes beam{0%{top:-10%}50%{top:110%}100%{top:-10%}}

    /* hologram base glow */
    .holo-base{position:absolute;left:50%;bottom:6%;transform:translateX(-50%);width:54%;height:10px;background:radial-gradient(closest-side, rgba(124,77,255,0.22), transparent);filter:blur(20px);opacity:0.9}

    /* UI controls */
    #controls{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;z-index:60}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:10px 14px;border-radius:12px;font-weight:600;backdrop-filter:blur(6px);cursor:pointer}
    .btn.secondary{color:#fff;opacity:0.85}
    .btn:disabled{opacity:0.35;cursor:not-allowed}

    /* top-left HUD */
    #hud{position:fixed;left:18px;top:18px;z-index:60;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.14));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.04)}
    #hud .title{font-size:13px;color:rgba(255,255,255,0.9);font-weight:700}
    #hud .sub{font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px}

    /* labels holographic panel */
    #labels{position:fixed;right:18px;top:18px;z-index:60;min-width:180px;max-width:46%;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(10,8,16,0.35), rgba(8,6,14,0.55));border:1px solid rgba(124,77,255,0.12);backdrop-filter: blur(8px)}
    .label-line{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px;margin-bottom:6px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow: 0 6px 18px rgba(10,8,16,0.5) inset}
    .label-name{font-weight:700;color:#e9f8ff}
    .label-prob{font-weight:800;color:var(--accent)}

    /* central HUD text during loading */
    #center-ui{position:absolute;left:50%;top:54%;transform:translate(-50%,-50%);text-align:center;z-index:62;pointer-events:none}
    .status{font-family:monospace;font-size:14px;color:rgba(255,255,255,0.9);margin-top:10px}

    /* loading bars */
    .load-wrap{display:flex;align-items:center;gap:10px;justify-content:center}
    .loader{width:220px;height:10px;border-radius:8px;background:rgba(255,255,255,0.03);overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .loader > i{display:block;height:100%;width:40%;background:linear-gradient(90deg,var(--accent),var(--accent2));transform:translateX(-100%);animation:load 2s linear infinite}
    @keyframes load{0%{transform:translateX(-100%)}100%{transform:translateX(220px)}}

    /* subtle grid overlay */
    .grid{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.01) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.01) 1px, transparent 1px);background-size:120px 120px,120px 120px;opacity:0.6;mix-blend-mode:overlay;pointer-events:none}

    /* small responsive tweaks */
    @media (max-width:640px){.holo-stage{width:86vmin;height:86vmin}.loader{width:160px}}
  </style>
</head>
<body>
  <div id="app">
    <div id="camera-wrap">
      <video id="video" playsinline autoplay muted></video>

      <!-- hologram visual elements -->
      <div class="holo-stage" aria-hidden="true">
        <div class="ring r1"></div>
        <div class="ring r2"></div>
        <div class="ring r3"></div>
        <div class="scan-beam"></div>
        <div class="holo-base"></div>
      </div>

      <canvas id="capture" style="display:none"></canvas>
      <div class="grid"></div>

      <div id="center-ui">
        <div id="loadingBox">
          <div style="font-weight:800;font-size:20px;letter-spacing:1px;color:var(--accent)">SYSTEM READY</div>
          <div class="status" id="statusText">Idle</div>
          <div class="load-wrap" style="margin-top:12px">
            <div class="loader"><i></i></div>
          </div>
        </div>
      </div>
    </div>

    <div id="hud">
      <div class="title">Live Scan · Holographic</div>
      <div class="sub">Model: OEXYCpyXs</div>
    </div>

    <div id="labels" aria-live="polite"></div>

    <div id="controls">
      <button class="btn" id="startBtn">Start Scan</button>
      <button class="btn secondary" id="stopBtn" disabled>Stop</button>
      <button class="btn secondary" id="torchBtn" disabled>Torch</button>
      <button class="btn secondary" id="fsBtn">Fullscreen</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <script>
    const MODEL_BASE = 'https://teachablemachine.withgoogle.com/models/OEXYCpyXs/';

    let model = null; let maxPredictions = 0;
    const video = document.getElementById('video');
    const canvas = document.getElementById('capture');
    const labelsEl = document.getElementById('labels');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const torchBtn = document.getElementById('torchBtn');
    const fsBtn = document.getElementById('fsBtn');
    const statusText = document.getElementById('statusText');

    let stream = null; let track = null; let imageCapture = null; let running = false; let rafId = null;

    async function loadModel(){
      statusText.textContent = 'Loading model...';
      const modelURL = MODEL_BASE + 'model.json';
      const metadataURL = MODEL_BASE + 'metadata.json';
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
      statusText.textContent = 'Model loaded';
    }

    async function startCamera(){
      statusText.textContent = 'Starting camera...';
      const constraintsList = [
        {video: {width: {ideal:1280}, height: {ideal:720}, facingMode: {exact: 'environment'}}},
        {video: {width: {ideal:1280}, height: {ideal:720}, facingMode: 'environment'}},
        {video: {width: {ideal:640}, height: {ideal:480}}}
      ];
      for(const c of constraintsList){
        try{ stream = await navigator.mediaDevices.getUserMedia(c); break; }catch(e){}
      }
      if(!stream) throw new Error('Tidak dapat mengakses kamera. Pastikan halaman dijalankan via HTTPS dan akses kamera diizinkan.');
      video.srcObject = stream; track = stream.getVideoTracks()[0];
      try{ imageCapture = new ImageCapture(track); }catch(e){ imageCapture = null }
      await video.play();
      canvas.width = video.videoWidth || video.clientWidth; canvas.height = video.videoHeight || video.clientHeight;
      statusText.textContent = 'Camera running';
    }

    async function enableTorchIfAvailable(){
      if(!track) return false;
      const cap = track.getCapabilities ? track.getCapabilities() : {};
      if(cap.torch){ torchBtn.disabled = false; return true; }
      try{ const pc = imageCapture ? await imageCapture.getPhotoCapabilities() : null; if(pc && pc.fillLightMode && pc.fillLightMode.length){ torchBtn.disabled = false; return true; } }catch(e){}
      torchBtn.disabled = true; return false;
    }

    async function setTorch(on){ if(!track) return; const cap = track.getCapabilities ? track.getCapabilities() : {}; if(cap.torch){ try{ await track.applyConstraints({advanced:[{torch:on}]}); return; }catch(e){} } if(imageCapture){ try{ await imageCapture.takePhoto({fillLightMode: on ? 'flash' : 'off'}); }catch(e){} } }

    // sequence: visual loading -> start camera -> hologram scanning
    async function runSequence(){
      startBtn.disabled = true; stopBtn.disabled = true; statusText.textContent = 'Preparing system...';
      // small animated steps
      await delay(600);
      statusText.textContent = 'Memuat model AI';
      await loadModel();
      await delay(500);
      statusText.textContent = 'Mengaktifkan kamera belakang';
      await startCamera();
      await enableTorchIfAvailable();
      statusText.textContent = 'Memulai pemindaian holografis';
      // brief holo warmup
      await delay(800);
      // enter fullscreen if possible
      try{ await document.documentElement.requestFullscreen(); }catch(e){}
      stopBtn.disabled = false; startBtn.disabled = true; startLoop();
    }

    async function startLoop(){
      running = true; const ctx = canvas.getContext('2d');
      const holoPulse = ()=>{
        // small visual pulse on labels
        labelsEl.style.transform = 'scale(1.02)'; setTimeout(()=>labelsEl.style.transform='scale(1)',120);
      }
      async function loop(){
        if(!running) return;
        canvas.width = video.videoWidth || video.clientWidth; canvas.height = video.videoHeight || video.clientHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        if(model){
          try{
            const prediction = await model.predict(canvas);
            prediction.sort((a,b)=>b.probability - a.probability);
            labelsEl.innerHTML = '';
            for(let i=0;i<Math.min(4,prediction.length);i++){
              const p = prediction[i];
              const line = document.createElement('div'); line.className='label-line';
              line.innerHTML = `<div class="label-name">${p.className}</div><div class="label-prob">${(p.probability*100).toFixed(1)}%</div>`;
              labelsEl.appendChild(line);
            }
            holoPulse();
          }catch(e){ console.warn('Predict error', e); }
        }
        rafId = requestAnimationFrame(loop);
      }
      loop();
    }

    async function stopAll(){ running=false; if(rafId) cancelAnimationFrame(rafId); if(stream) stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; imageCapture=null; video.srcObject=null; labelsEl.innerHTML=''; stopBtn.disabled=true; startBtn.disabled=false; torchBtn.disabled=true; statusText.textContent='Idle'; try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){} }

    function delay(ms){ return new Promise(res=>setTimeout(res,ms)); }

    startBtn.addEventListener('click', async ()=>{ try{ await runSequence(); }catch(err){ alert(err.message||err); startBtn.disabled=false; statusText.textContent='Error'; } });
    stopBtn.addEventListener('click', stopAll);
    torchBtn.addEventListener('click', async ()=>{ if(!track) return; const on = torchBtn.dataset.on !== 'true'; await setTorch(on); torchBtn.dataset.on = on ? 'true' : 'false'; torchBtn.textContent = on ? 'Torch ON' : 'Torch'; });
    fsBtn.addEventListener('click', async ()=>{ try{ if(!document.fullscreenElement) await document.documentElement.requestFullscreen(); else await document.exitFullscreen(); }catch(e){} });

    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden'){ running=false; }else{ if(stream && !running) startLoop(); } });
    window.addEventListener('beforeunload', ()=>{ if(stream) stream.getTracks().forEach(t=>t.stop()); });
  </script>
</body>
</html>
