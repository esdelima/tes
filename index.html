<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Re-Think Mataram HARUM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <style>
        /* =========================
   Re-Think | Mataram HARUM
   Full inline CSS untuk <style> di <head>
   ========================= */

body {
    font-family: 'Poppins', sans-serif;
    background-color: #f0f9ff;
    overflow-x: hidden;
}
.mode-selection {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}
.ar-content {
    transition: all 0.3s ease;
}
.ar-content:hover {
    transform: scale(1.05);
}
.compass-arrow {
    transition: transform 0.5s ease;
}
#teacher-map, #student-map {
    height: 100%;
    width: 100%;
    border-radius: 12px;
}
.camera-feed {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    background-color: #000;
}
.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    perspective: 1000px;
    transform-style: preserve-3d;
}
.ar-object {
    position: absolute;
    transform-style: preserve-3d;
    pointer-events: auto;
    transition: opacity 0.3s ease;
}
.ar-object-content {
    position: relative;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transform-origin: center;
    transform-style: preserve-3d;
    backface-visibility: hidden;
    max-width: 300px;
    min-width: 150px;
}
.ar-object-anchor {
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: rgba(37, 99, 235, 0.9);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
}
.ar-object-anchor::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: rgba(37, 99, 235, 0.3);
    transform: translate(-50%, -50%);
    animation: pulse 2s infinite;
}
.ar-indicator {
    position: absolute;
    padding: 8px 12px;
    background-color: rgba(37, 99, 235, 0.9);
    color: white;
    border-radius: 20px;
    font-weight: 500;
    transform: translate(-50%, -50%);
    z-index: 20;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    pointer-events: auto;
}
.direction-arrow {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 60px;
    background-color: rgba(37, 99, 235, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.arrow {
    width: 30px;
    height: 30px;
    border-top: 6px solid white;
    border-right: 6px solid white;
    transform-origin: center;
}
.nearby-notification {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(37, 99, 235, 0.9);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    z-index: 20;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.content-list {
    max-height: 300px;
    overflow-y: auto;
}
.map-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    border-radius: 12px;
}
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(59, 130, 246, 0.3);
    border-radius: 50%;
    border-top-color: #3b82f6;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}
.location-button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background-color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
}
.location-button:hover {
    background-color: #f3f4f6;
    transform: scale(1.05);
}
.ar-anchor-settings {
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
    margin-top: 1rem;
}
.map-control-button {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background-color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
}
.map-control-button:hover {
    background-color: #f3f4f6;
    transform: scale(1.05);
}
.compass-container {
    position: absolute;
    top: 80px;
    left: 20px;
    z-index: 900;
    background-color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.compass-needle {
    position: absolute;
    width: 4px;
    height: 24px;
    background: linear-gradient(to bottom, #dc2626 50%, #1d4ed8 50%);
    transform-origin: center;
    transition: transform 0.3s ease;
}
.compass-circle {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #fff;
    border: 2px solid #6b7280;
    border-radius: 50%;
}
.debug-info {
    position: absolute;
    bottom: 160px;
    left: 10px;
    background-color: rgba(255, 255, 255, 0.8);
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 12px;
    z-index: 900;
    max-width: 200px;
}
.back-button {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 1000;
    background-color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
}
.top-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    gap: 10px;
}
.control-button {
    background-color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
}
.place-button {
    position: absolute;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
    background-color: #10b981;
    color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
}
.place-button:hover {
    background-color: #059669;
    transform: scale(1.05);
}
.coordinate-display {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    max-width: 90%;
    width: 400px;
}
.coordinate-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e5e7eb;
}
.coordinate-item:last-child {
    border-bottom: none;
}
.copy-button {
    background-color: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.copy-button:hover {
    background-color: #2563eb;
}
.copy-button.copied {
    background-color: #10b981;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
}
.calibration-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    padding: 20px;
}
.calibration-animation {
    width: 200px;
    height: 200px;
    margin: 20px 0;
    position: relative;
}
.calibration-phone {
    width: 80px;
    height: 140px;
    background-color: #3b82f6;
    border-radius: 10px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: rotate-phone 4s infinite ease-in-out;
}
.ar-content-display {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 950;
    max-height: 40vh;
    overflow-y: auto;
}
.ar-content-display h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #1e3a8a;
}
.ar-content-display .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background-color: #f3f4f6;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
.ar-object-3d {
    position: absolute;
    transform-style: preserve-3d;
    pointer-events: auto;
}
.ar-object-3d-model {
    width: 200px;
    height: 200px;
    transform-style: preserve-3d;
}
.ar-object-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
.ar-object-video {
    width: 320px;
    height: 240px;
    background-color: #000;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}
.ar-object-presentation {
    width: 240px;
    height: 180px;
    background-color: #fff;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid #ddd;
    overflow: hidden;
}
.ar-object-text {
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    max-width: 250px;
}
.ar-object-floating {
    animation: float 3s infinite ease-in-out;
}
.treasure-box {
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #8B4513, #D2691E);
    border-radius: 8px;
    position: relative;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    border: 3px solid #654321;
    animation: treasureGlow 2s infinite ease-in-out;
}
.treasure-box::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 10%;
    right: 10%;
    height: 16px;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    border-radius: 8px 8px 0 0;
    border: 2px solid #B8860B;
}
.treasure-box::after {
    content: 'üîí';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}
.treasure-box.opened::after {
    content: '‚ú®';
    animation: sparkle 1s infinite;
}
.treasure-box.can-open {
    animation: treasureReady 1s infinite ease-in-out;
    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
}
.treasure-box.can-open::before {
    background: linear-gradient(45deg, #FFD700, #FFFF00);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
}
.ar-object-revealed {
    animation: revealContent 1s ease-out;
    transform-origin: center bottom;
}
.open-box-button {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: #8B4513;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    animation: buttonPulse 1.5s infinite;
}
.distance-requirement {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 15px;
    padding: 4px 12px;
    font-size: 10px;
    white-space: nowrap;
}
@keyframes float {
    0% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-10px) rotate(2deg); }
    100% { transform: translateY(0px) rotate(0deg); }
}
@keyframes treasureGlow {
    0% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 8px 25px rgba(139,69,19,0.5); }
    100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
}
@keyframes treasureReady {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
@keyframes sparkle {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
    100% { transform: translate(-50%, -50%) scale(1); }
}
@keyframes revealContent {
    0% { opacity: 0; transform: scale(0.3) translateY(50px); }
    50% { opacity: 0.8; transform: scale(1.1) translateY(-10px); }
    100% { opacity: 1; transform: scale(1) translateY(0px); }
}
@keyframes buttonPulse {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.05); }
    100% { transform: translateX(-50%) scale(1); }
}
@keyframes rotate-phone {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    25% { transform: translate(-50%, -50%) rotate(90deg); }
    50% { transform: translate(-50%, -50%) rotate(180deg); }
    75% { transform: translate(-50%, -50%) rotate(270deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}
.ar-object-label {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(37, 99, 235, 0.9);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 12px;
    white-space: nowrap;
}
.ar-object-distance {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
}
.world-anchored-object {
    position: absolute;
    transform-style: preserve-3d;
    pointer-events: auto;
    z-index: 100;
}
.world-anchored-content {
    transform-style: preserve-3d;
    backface-visibility: hidden;
}
.world-anchored-3d {
    width: 200px;
    height: 200px;
    transform-style: preserve-3d;
}
.world-anchored-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
.world-anchored-video {
    width: 320px;
    height: 240px;
    background-color: #000;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}
.ar-view-mode-toggle {
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
    background-color: white;
    border-radius: 20px;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    font-weight: 500;
    color: #2563eb;
}
model-viewer {
    width: 100%;
    height: 300px;
    background-color: #f3f4f6;
    --poster-color: #f3f4f6;
}
.presentation-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}
.presentation-controls button {
    background-color: #4f46e5;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
}
.presentation-controls button:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}
.presentation-slide {
    width: 100%;
    height: 300px;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    overflow: hidden;
}
.presentation-slide iframe {
    width: 100%;
    height: 100%;
    border: none;
}
.presentation-slide img {
    max-width: 100%;
    max-height: 100%;
}
.slide-counter {
    text-align: center;
    margin-top: 8px;
    font-size: 14px;
    color: #4b5563;
}
.youtube-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    border-radius: 8px;
}
.youtube-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
.calibration-phone {
    width: 80px;
    height: 140px;
    background-color: #3b82f6;
    border-radius: 10px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: rotate-phone 4s infinite ease-in-out;
}
.debug-info {
    font-family: inherit;
}
.content-list .text-center {
    font-family: inherit;
}

/* Content viewer (modal) explicit styles so inline modal looks consistent */
#content-viewer {
    position: fixed;
    inset: 0;
    z-index: 60;
    display: none; /* tailwind .hidden controls visibility; JS toggles class */
    align-items: center;
    justify-content: center;
    background-color: rgba(0,0,0,0.6);
    padding: 20px;
}
#content-viewer:not(.hidden) {
    display: flex;
}
#content-viewer .viewer-box {
    background: #fff;
    border-radius: 12px;
    padding: 18px;
    width: 100%;
    max-width: 920px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}
#viewer-title {
    font-size: 20px;
    font-weight: 600;
    color: #111827;
}
#viewer-body {
    margin-top: 12px;
    color: #374151;
}

/* Content list modal small tweaks (in case tailwind classes not loaded) */
#content-list-modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: none;
    align-items: flex-end;
    justify-content: center;
    background: rgba(0,0,0,0.5);
}
#content-list-modal:not(.hidden) {
    display: flex;
}
#content-list-modal .bg-white {
    width: 100%;
    max-width: 420px;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
}

/* small responsive niceties */
@media (max-width: 640px) {
    .ar-object-label { font-size: 11px; padding: 3px 8px; }
    .ar-object-distance { font-size: 9px; padding: 2px 6px; }
    .open-box-button { padding: 6px 12px; font-size: 11px; }
    .viewer-box { padding: 14px; }
}
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading-screen" class="mode-selection min-h-screen flex flex-col items-center justify-center p-6 text-white">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold mb-2">Re-Think | Mataram HARUM</h1>
                <p class="text-xl opacity-90">Memuat konten AR...</p>
            </div>
            <div class="spinner mb-4"></div>
            <p id="loading-status" class="text-lg opacity-80">Mengambil data dari server...</p>
        </div>

        <!-- Student Mode -->
        <div id="student-mode" class="hidden min-h-screen bg-gray-100">
            <!-- Camera View -->
            <div id="camera-view" class="relative h-screen">
                <div class="camera-feed h-full w-full">
                    <video id="camera-feed" class="h-full w-full object-cover" autoplay playsinline></video>
                    <div class="camera-overlay" id="ar-overlay"></div>
                    
                    <!-- Back button -->
                    <div class="back-button" onclick="location.reload()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>

                    <!-- Top controls -->
                    <div class="top-controls">
                        <div class="control-button" onclick="toggleView('map')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                        </div>
                        <div class="control-button" onclick="showContentList()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </div>
                        <div class="control-button" onclick="toggleDebugInfo()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Compass -->
                    <div class="compass-container">
                        <div class="compass-needle" id="compass-needle"></div>
                        <div class="compass-circle"></div>
                    </div>

                    <!-- Direction arrow -->
                    <div class="direction-arrow" id="direction-arrow">
                        <div class="arrow" id="arrow"></div>
                    </div>

                    <!-- Distance indicator -->
                    <div class="absolute bottom-20 left-0 right-0 text-center text-white text-lg font-semibold" id="distance-indicator">
                        Mencari konten terdekat...
                    </div>

                    <!-- Debug info -->
                    <div class="debug-info hidden" id="debug-info">Arah: 0¬∞<br>Target: N/A<br>Bearing: N/A</div>

                    <!-- AR View Mode Toggle -->
                    <div class="ar-view-mode-toggle" onclick="toggleARViewMode()">
                        <span id="ar-view-mode-text">Tampilan AR: Dunia Nyata</span>
                    </div>

                </div>

                <!-- Calibration button -->
                <div class="absolute top-80 right-4 z-1000">
                    <button onclick="showCalibration()" class="bg-white text-blue-600 px-3 py-2 rounded-lg shadow-md text-sm">
                        üìç Kalibrasi
                    </button>
                </div>
            </div>

            <!-- Map View -->
            <div id="map-view" class="hidden h-screen relative">
                <div id="student-map" class="h-full w-full"></div>

                <!-- Back button -->
                <div class="back-button" onclick="location.reload()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>

                <!-- Camera button -->
                <div class="map-control-button" onclick="toggleView('camera')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>

                <!-- Location button -->
                <div class="location-button" id="student-use-current-location">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
            </div>

            <!-- Content List Modal -->
            <div id="content-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end justify-center">
                <div class="bg-white rounded-t-xl w-full max-w-md max-h-[70vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Konten AR</h3>
                        <button onclick="hideContentList()" class="text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="content-list p-4" id="nearby-content-list">
                        <div class="text-center py-8 text-gray-500">Tidak ada konten AR terdekat</div>
                    </div>
                </div>
            </div>

            <!-- Calibration Modal -->
            <div id="calibration-overlay" class="hidden calibration-overlay">
                <h2 class="text-2xl font-bold mb-2">Kalibrasi Kompas Anda</h2>
                <p class="mb-4">Untuk posisi AR yang akurat, silakan putar perangkat Anda dalam pola angka 8</p>
                <div class="calibration-animation">
                    <div class="calibration-phone"></div>
                </div>
                <p class="mb-6">Terus putar hingga animasi selesai</p>
                <button onclick="finishCalibration()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-all">Saya Sudah Selesai Kalibrasi</button>
            </div>
        </div>
    </div>

    <!-- Simple modal untuk menampilkan konten saat dibuka -->
    <div id="content-viewer" class="hidden fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-60">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-start">
                <h3 id="viewer-title" class="text-xl font-semibold"></h3>
                <button onclick="closeContentViewer()" class="text-gray-500">Tutup</button>
            </div>
            <div id="viewer-body" class="mt-4"></div>
        </div>
    </div>

    <script>
        // -----------------------
        // Global variables
        // -----------------------
        let currentMode = null;
        let teacherMap = null;
        let studentMap = null;
        let currentPosition = null;
        let watchPositionId = null;
        let selectedPin = null;
        let arContents = [];
        let currentHeading = 0;
        let targetARContent = null;
        let cameraStream = null;
        let teacherMapInitialized = false;
        let studentMapInitialized = false;
        let compassCalibrated = false;
        let compassOffset = 0;
        let absoluteHeading = 0;
        let useAbsoluteHeading = false;
        let currentlyDisplayedContent = null;
        let lastNearbyContent = [];
        let arViewMode = "realworld"; // "realworld" or "indicator"
        let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        let arObjects = [];
        let lastUpdateTime = 0;
        let animationFrameId = null;
        let presentationSlides = {};
        let currentPresentationState = {};
        let openedBoxes = new Set();
        let boxOpenDistance = 15; // meters to allow opening via AR UI
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3gcrsiBqijSgAqWi01ux417lYWx-JlMDlDeWI_qgrGU1FU7LKc5xL6xmKmGgSUj_UCucrug7M4ZBz/pub?gid=0&single=true&output=csv';

        // -----------------------
        // Initialization
        // -----------------------
        window.addEventListener('load', initApp);

        function initApp() {
            document.getElementById('loading-screen').classList.remove('hidden');
            loadCSVData();

            // Orientation events
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientationabsolute', function(event) {
                    useAbsoluteHeading = true;
                    handleOrientation(event);
                    deviceOrientation = {
                        alpha: event.alpha || 0,
                        beta: event.beta || 0,
                        gamma: event.gamma || 0
                    };
                });
            }
        }

        // -----------------------
        // CSV loading & parsing
        // -----------------------
        async function loadCSVData() {
            try {
                document.getElementById('loading-status').textContent = 'Mengambil data dari server...';
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
                const csvText = await response.text();
                document.getElementById('loading-status').textContent = 'Memproses konten AR...';

                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                const nameIndex = headers.findIndex(h => h.includes('name') || h.includes('title') || h.includes('nama'));
                const latIndex = headers.findIndex(h => h.includes('lat'));
                const lonIndex = headers.findIndex(h => h.includes('lon') || h.includes('lng'));
                const urlIndex = headers.findIndex(h => h.includes('url'));
                const radiusIndex = headers.findIndex(h => h.includes('radius')); // optional column
                const descIndex = headers.findIndex(h => h.includes('description') || h.includes('desc')) ;
                // fallback: description is next to url
                const fallbackDescIndex = Math.min(urlIndex + 1, headers.length - 1);

                if (nameIndex === -1 || latIndex === -1 || lonIndex === -1 || urlIndex === -1) {
                    throw new Error('Kolom yang diperlukan tidak ditemukan dalam CSV. Diharapkan: name, lat, lon, url');
                }

                arContents = [];

                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',').map(cell => cell.trim());
                    if (row.length >= Math.max(nameIndex, latIndex, lonIndex, urlIndex) + 1) {
                        const name = row[nameIndex];
                        const lat = parseFloat(row[latIndex]);
                        const lon = parseFloat(row[lonIndex]);
                        const url = row[urlIndex];
                        const radiusVal = (radiusIndex !== -1) ? parseFloat(row[radiusIndex]) : NaN;
                        const description = (descIndex !== -1) ? row[descIndex] : (row[fallbackDescIndex] || '');

                        if (name && !isNaN(lat) && !isNaN(lon) && url) {
                            let contentType = 'image';
                            let processedContent = url;
                            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                                contentType = 'video';
                                processedContent = extractYouTubeID(url);
                            } else if (url.toLowerCase().includes('.glb') || url.toLowerCase().includes('.gltf')) {
                                contentType = '3d';
                            } else if (url.includes(',')) {
                                contentType = 'presentation';
                                const slides = url.split(',').map(u => u.trim()).filter(u => u);
                                processedContent = JSON.stringify(slides);
                            }

                            const arContent = {
                                id: `csv_${i}_${Date.now()}`,
                                title: name,
                                type: contentType,
                                content: processedContent,
                                description: description || '',
                                lat: lat,
                                lng: lon,
                                radius: !isNaN(radiusVal) ? radiusVal : 50, // default 50m
                                height: 1.5,
                                anchorType: 'fixed',
                                scale: 1.0,
                                rotation: 0
                            };

                            arContents.push(arContent);
                        }
                    }
                }

                document.getElementById('loading-status').textContent = `Memuat ${arContents.length} lokasi AR!`;
                saveARContentsToStorage();

                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('student-mode').classList.remove('hidden');
                    currentMode = 'student';
                    initStudentMode();
                }, 800);
            } catch (error) {
                console.error('Error loading CSV data:', error);
                document.getElementById('loading-status').textContent = 'Gagal memuat data. Menggunakan konten offline...';
                loadARContents();
                if (arContents.length === 0) {
                    document.getElementById('loading-status').textContent = 'Tidak ada konten AR tersedia. Periksa koneksi.';
                    setTimeout(() => location.reload(), 3000);
                } else {
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('student-mode').classList.remove('hidden');
                        currentMode = 'student';
                        initStudentMode();
                    }, 800);
                }
            }
        }

        function saveARContentsToStorage() {
            try {
                localStorage.setItem('arContents', JSON.stringify(arContents));
            } catch (e) { console.warn('Gagal menyimpan arContents', e); }
        }
        function loadARContents() {
            try {
                const raw = localStorage.getItem('arContents');
                if (raw) {
                    arContents = JSON.parse(raw);
                } else {
                    arContents = [];
                }
            } catch (e) {
                console.warn('Gagal membaca arContents', e);
                arContents = [];
            }
        }

        // -----------------------
        // Geolocation & Camera
        // -----------------------
        function getCurrentLocation(centerMap = false) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    currentPosition = { lat: latitude, lng: longitude, accuracy: accuracy };
                    if (currentMode === 'student') {
                        if (studentMap) {
                            studentMap.setView([latitude, longitude], 18);
                            updateStudentMapMarkers();
                        }
                        checkNearbyARContent();
                    }
                },
                (error) => {
                    console.error('Error getting location:', error);
                    alert('Tidak dapat mendapatkan lokasi Anda. Aktifkan layanan lokasi.');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const videoElement = document.getElementById('camera-feed');
                        videoElement.srcObject = stream;
                        cameraStream = stream;
                    })
                    .catch(error => {
                        console.error('Error accessing camera:', error);
                        alert('Tidak dapat mengakses kamera. Izinkan akses kamera.');
                    });
            } else {
                alert('Browser tidak mendukung akses kamera.');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        // -----------------------
        // Maps & markers
        // -----------------------
        function initStudentMode() {
            startCamera();
            if (!studentMapInitialized) {
                studentMap = L.map('student-map').setView([0,0], 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(studentMap);
                studentMapInitialized = true;
                document.getElementById('student-use-current-location').addEventListener('click', () => {
                    if (currentPosition) studentMap.setView([currentPosition.lat, currentPosition.lng], 18);
                });
            }
            startLocationTracking();
            startOrientationTracking();
            loadOpenedBoxes(); // <- important: restore opened state
            loadARContents();
            startARRenderingLoop();
        }

        function updateStudentMapMarkers() {
            if (!studentMap || !currentPosition) return;

            // remove markers and circles (keep tile layer)
            studentMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polyline) {
                    studentMap.removeLayer(layer);
                }
            });

            // current position marker
            L.marker([currentPosition.lat, currentPosition.lng], {
                icon: L.divIcon({
                    className: 'current-position-marker',
                    html: `<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white"></div>`,
                    iconSize: [20,20],
                    iconAnchor: [10,10]
                })
            }).addTo(studentMap);

            // accuracy circle
            L.circle([currentPosition.lat, currentPosition.lng], {
                radius: currentPosition.accuracy || 10,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(studentMap);

            // AR content markers + radius circle
            arContents.forEach(content => {
                const marker = L.marker([content.lat, content.lng], {
                    icon: L.divIcon({
                        className: 'ar-marker',
                        html: `<div class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white">${getContentTypeIcon(content.type)}</div>`,
                        iconSize: [24,24],
                        iconAnchor: [12,12]
                    })
                }).addTo(studentMap);

                L.circle([content.lat, content.lng], {
                    radius: content.radius,
                    color: '#4f46e5',
                    fillColor: '#4f46e5',
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(studentMap);

                marker.on('click', () => {
                    targetARContent = content;
                    updateDirectionArrow();
                    alert(`Navigasi ke: ${content.title}`);
                    toggleView('camera');
                });
            });

            if (targetARContent && currentPosition) {
                L.polyline([
                    [currentPosition.lat, currentPosition.lng],
                    [targetARContent.lat, targetARContent.lng]
                ], {
                    color: '#4f46e5',
                    weight: 3,
                    dashArray: '5,10',
                    opacity: 0.8
                }).addTo(studentMap);
            }
        }

        function getContentTypeIcon(type) {
            switch(type) {
                case 'text': return 'T';
                case 'image': return 'G';
                case '3d': return '3D';
                case 'video': return 'V';
                case 'presentation': return 'P';
                default: return '?';
            }
        }

        // -----------------------
        // Location & orientation tracking
        // -----------------------
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchPositionId = navigator.geolocation.watchPosition(
                    position => {
                        const { latitude, longitude, accuracy } = position.coords;
                        currentPosition = { lat: latitude, lng: longitude, accuracy: accuracy };
                        if (studentMap) {
                            studentMap.setView([latitude, longitude], 18);
                            updateStudentMapMarkers();
                        }
                        checkNearbyARContent();
                    },
                    error => {
                        console.error('Error tracking location:', error);
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
            } else {
                alert('Geolokasi tidak didukung oleh browser Anda.');
            }
        }

        function startOrientationTracking() {
            if (window.DeviceOrientationEvent) {
                if (!useAbsoluteHeading) {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            } else {
                /* nothing */
            }
        }

        function handleOrientation(event) {
            if (event.alpha !== null && event.alpha !== undefined) {
                if (useAbsoluteHeading) {
                    absoluteHeading = event.alpha;
                    currentHeading = (360 - absoluteHeading) % 360;
                } else {
                    currentHeading = (event.alpha + compassOffset) % 360;
                }
                deviceOrientation = {
                    alpha: event.alpha || 0,
                    beta: event.beta || 0,
                    gamma: event.gamma || 0
                };
                const compassNeedle = document.getElementById('compass-needle');
                if (compassNeedle) compassNeedle.style.transform = `rotate(${currentHeading}deg)`;
                updateDirectionArrow();
                updateDebugInfo();
            }
        }

        function showCalibration() { document.getElementById('calibration-overlay').classList.remove('hidden'); }
        function finishCalibration() {
            document.getElementById('calibration-overlay').classList.add('hidden');
            compassCalibrated = true;
            if (!useAbsoluteHeading && currentPosition) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        if (position.coords.heading !== null && position.coords.heading !== undefined) {
                            const deviceHeading = position.coords.heading;
                            compassOffset = (deviceHeading - currentHeading + 360) % 360;
                            console.log('Calibrated compass. Offset:', compassOffset);
                        }
                    },
                    error => { console.log('No heading from geolocation', error); },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }
        }

        // -----------------------
        // Nearby checking & AR objects
        // -----------------------
        function checkNearbyARContent() {
            if (!currentPosition) return;

            let nearbyContent = [];
            let closestDistance = Infinity;
            let closestContent = null;

            arContents.forEach(content => {
                const distance = calculateDistance(currentPosition.lat, currentPosition.lng, content.lat, content.lng);
                content.distance = distance;
                if (distance <= content.radius) {
                    nearbyContent.push(content);
                }
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestContent = content;
                }
            });

            const distanceIndicator = document.getElementById('distance-indicator');
            if (closestContent) {
                distanceIndicator.textContent = `${closestContent.title}: ${Math.round(closestContent.distance)}m`;
                if (!targetARContent) targetARContent = closestContent;
            } else {
                distanceIndicator.textContent = 'Tidak ada konten AR terdekat';
            }

            // update list & AR objects
            updateNearbyContentList(nearbyContent);
            updateDebugInfo();
            updateARObjects(nearbyContent);
            lastNearbyContent = nearbyContent;
        }

        function updateARObjects(nearbyContent) {
            // If indicator mode, overlay simple indicators (we still want them to appear)
            const overlay = document.getElementById('ar-overlay');
            overlay.innerHTML = '';

            if (arViewMode === "indicator") {
                nearbyContent = nearbyContent || arContents.slice(); // if empty, try show some
                // We'll display all arContents as indicators in menu-based UX context
                const toShow = arContents; // show all
                toShow.forEach(content => {
                    const isBoxOpened = openedBoxes.has(content.id);
                    const canOpenBox = (content.distance !== undefined) && (content.distance <= boxOpenDistance);
                    const indicator = document.createElement('div');
                    indicator.className = 'ar-indicator';
                    if (!isBoxOpened) {
                        indicator.textContent = canOpenBox ? 'üéÅ Buka Kotak' : 'üéÅ Kotak Misterius';
                        indicator.style.backgroundColor = canOpenBox ? 'rgba(255,215,0,0.9)' : 'rgba(139,69,19,0.9)';
                        indicator.style.color = canOpenBox ? '#8B4513' : 'white';
                    } else {
                        indicator.textContent = content.title;
                        indicator.style.backgroundColor = 'rgba(37,99,235,0.9)';
                        indicator.style.color = 'white';
                    }

                    // compute bearing -> position
                    let viewportX = '50%';
                    let viewportY = '50%';
                    if (currentPosition) {
                        const bearing = calculateBearing(currentPosition.lat, currentPosition.lng, content.lat, content.lng);
                        const relativeBearing = (bearing - currentHeading + 360) % 360;
                        if (relativeBearing < 60 || relativeBearing > 300) {
                            if (relativeBearing < 60) viewportX = (50 + (relativeBearing / 60) * 40) + '%';
                            else viewportX = (50 - ((360 - relativeBearing) / 60) * 40) + '%';
                        } else {
                            // out of FOV: push to side
                            viewportX = '90%';
                        }
                        viewportY = (50 - ((content.height || 1.5) * 5) + ((content.distance || content.radius) / (content.radius || 100)) * 10) + '%';
                    }
                    indicator.style.left = viewportX;
                    indicator.style.top = viewportY;
                    indicator.style.transform = 'translate(-50%,-50%)';
                    indicator.addEventListener('click', () => {
                        // If unlocked or already opened, show; else if far -> show message
                        if (openedBoxes.has(content.id)) {
                            showARContent(content);
                        } else {
                            // Always allow opening from menu -> but here we show prompt to use menu
                            const confirmOpen = confirm('Anda mencoba membuka konten dari overlay. Gunakan tombol di menu untuk buka dari jauh atau pindah lebih dekat untuk membuka di AR. Mau buka sekarang dari menu?');
                            if (confirmOpen) {
                                revealContentFromMenu(content.id);
                            }
                        }
                    });
                    overlay.appendChild(indicator);
                });
            } else {
                // realworld view: render AR boxes for nearby content (but we still show boxes even if far via menu)
                if (!currentPosition) return;
                // Maintain arObjects list for those content that are in "nearbyContent"
                const existingIds = arObjects.map(o => o.id);
                const newIds = (nearbyContent || []).map(c => c.id);
                // remove ones not in new list
                arObjects = arObjects.filter(o => newIds.includes(o.id));
                // add new ones
                (nearbyContent || []).forEach(content => {
                    if (!existingIds.includes(content.id)) {
                        arObjects.push({ id: content.id, content: content, element: null });
                    }
                });
            }
        }

        function startARRenderingLoop() {
            function renderLoop() {
                const now = Date.now();
                if (now - lastUpdateTime > 50) {
                    renderARObjects();
                    lastUpdateTime = now;
                }
                animationFrameId = requestAnimationFrame(renderLoop);
            }
            renderLoop();
        }

        function renderARObjects() {
            if (arViewMode !== "realworld" || !currentPosition) return;
            const overlay = document.getElementById('ar-overlay');
            overlay.innerHTML = '';

            arObjects.forEach(arObject => {
                const content = arObject.content;
                const bearing = calculateBearing(currentPosition.lat, currentPosition.lng, content.lat, content.lng);
                const relativeBearing = (bearing - currentHeading + 360) % 360;
                if (relativeBearing < 60 || relativeBearing > 300) {
                    const arObjectElement = document.createElement('div');
                    arObjectElement.className = 'ar-object';
                    let viewportX;
                    if (relativeBearing < 60) viewportX = 50 + (relativeBearing / 60) * 40;
                    else viewportX = 50 - ((360 - relativeBearing) / 60) * 40;
                    const distance = content.distance || calculateDistance(currentPosition.lat, currentPosition.lng, content.lat, content.lng);
                    const maxDistance = content.radius || 100;
                    const distanceScaleFactor = 0.2 + (0.8 * (1 - Math.min(1, distance / maxDistance)));
                    const height = content.height || 1.5;
                    const deviceTilt = deviceOrientation.beta || 0;
                    const tiltAdjustment = (90 - deviceTilt) * 0.5;
                    const viewportY = 50 - (height * 3) - tiltAdjustment;

                    arObjectElement.style.left = `${Math.max(10, Math.min(90, viewportX))}%`;
                    arObjectElement.style.top = `${Math.max(10, Math.min(80, viewportY))}%`;

                    const userScale = content.scale || 1.0;
                    const totalScale = distanceScaleFactor * userScale;
                    const rotation = content.rotation || 0;
                    const isBoxOpened = openedBoxes.has(content.id);
                    const canOpenBox = distance <= boxOpenDistance;

                    let contentElement;
                    if (!isBoxOpened) {
                        contentElement = document.createElement('div');
                        contentElement.className = `treasure-box ${canOpenBox ? 'can-open' : ''}`;
                        if (canOpenBox) {
                            const openButton = document.createElement('button');
                            openButton.className = 'open-box-button';
                            openButton.textContent = 'Buka Kotak';
                            openButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openTreasureBox(content.id);
                            });
                            contentElement.appendChild(openButton);
                        } else {
                            const distanceReq = document.createElement('div');
                            distanceReq.className = 'distance-requirement';
                            distanceReq.textContent = `Dekati dalam ${boxOpenDistance}m`;
                            contentElement.appendChild(distanceReq);
                        }
                    } else {
                        if (content.type === 'text') {
                            contentElement = document.createElement('div');
                            contentElement.className = 'ar-object-text ar-object-revealed';
                            contentElement.innerHTML = `<p>${content.content}</p>`;
                        } else if (content.type === 'image') {
                            contentElement = document.createElement('img');
                            contentElement.className = 'ar-object-image ar-object-revealed';
                            contentElement.src = content.content;
                            contentElement.alt = content.title;
                        } else if (content.type === '3d') {
                            contentElement = document.createElement('div');
                            contentElement.className = 'ar-object-3d-model ar-object-revealed';
                            contentElement.innerHTML = `<model-viewer src="${content.content}" alt="${content.title}" auto-rotate camera-controls shadow-intensity="1" ar ar-modes="webxr scene-viewer quick-look" style="width:120px;height:120px;background-color:transparent;"></model-viewer>`;
                        } else if (content.type === 'video') {
                            contentElement = document.createElement('div');
                            contentElement.className = 'ar-object-video ar-object-revealed';
                            contentElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                        } else if (content.type === 'presentation') {
                            contentElement = document.createElement('div');
                            contentElement.className = 'ar-object-presentation ar-object-revealed';
                            contentElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>';
                        }
                    }

                    const label = document.createElement('div');
                    label.className = 'ar-object-label';
                    label.textContent = openedBoxes.has(content.id) ? content.title : 'üéÅ Kotak Misterius';
                    const distanceElement = document.createElement('div');
                    distanceElement.className = 'ar-object-distance';
                    distanceElement.textContent = `${Math.round(distance)}m`;

                    if (content.anchorType === 'floating') {
                        if (contentElement) contentElement.classList.add('ar-object-floating');
                    }

                    const perspectiveDistance = Math.max(100, 1000 - (distance * 10));
                    arObjectElement.style.transform = `translate(-50%,-50%) scale(${totalScale}) perspective(${perspectiveDistance}px) rotateY(${relativeBearing < 60 ? relativeBearing * 0.5 : (360 - relativeBearing) * -0.5}deg) rotateX(${(deviceOrientation.beta || 0 - 90) * 0.3}deg) rotateZ(${rotation}deg)`;
                    arObjectElement.style.transformStyle = 'preserve-3d';

                    if (contentElement) arObjectElement.appendChild(contentElement);
                    arObjectElement.appendChild(label);
                    arObjectElement.appendChild(distanceElement);

                    if (openedBoxes.has(content.id)) {
                        arObjectElement.addEventListener('click', () => showARContent(content));
                    }

                    overlay.appendChild(arObjectElement);
                    arObject.element = arObjectElement;
                }
            });
        }

        // -----------------------
        // Utilities: distance, bearing, arrow & debug
        // -----------------------
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            return bearing;
        }

        function updateDirectionArrow() {
            if (!currentPosition || !targetARContent) return;
            const bearing = calculateBearing(currentPosition.lat, currentPosition.lng, targetARContent.lat, targetARContent.lng);
            const relativeBearing = (bearing - currentHeading + 360) % 360;
            const arrow = document.getElementById('arrow');
            if (arrow) arrow.style.transform = `rotate(${relativeBearing - 45}deg)`;
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            if (!debugInfo) return;
            let debugText = `Arah: ${Math.round(currentHeading)}¬∞`;
            if (targetARContent && currentPosition) {
                const bearing = calculateBearing(currentPosition.lat, currentPosition.lng, targetARContent.lat, targetARContent.lng);
                const relativeBearing = (bearing - currentHeading + 360) % 360;
                debugText += `<br>Target: ${targetARContent.title}`;
                debugText += `<br>Bearing: ${Math.round(bearing)}¬∞`;
                debugText += `<br>Relatif: ${Math.round(relativeBearing)}¬∞`;
                debugText += `<br>Jarak: ${Math.round(targetARContent.distance || calculateDistance(currentPosition.lat, currentPosition.lng, targetARContent.lat, targetARContent.lng))}m`;
            } else {
                debugText += `<br>Target: N/A<br>Bearing: N/A`;
            }
            debugText += `<br>Mode: ${useAbsoluteHeading ? 'Absolut' : 'Relatif'} ${compassCalibrated ? '(Terkalibrasi)' : ''}`;
            debugText += `<br>Tampilan AR: ${arViewMode}`;
            debugInfo.innerHTML = debugText;
        }

        function toggleView(v) {
            if (v === 'map') {
                document.getElementById('camera-view').classList.add('hidden');
                document.getElementById('map-view').classList.remove('hidden');
                stopCamera();
                if (studentMap) studentMap.invalidateSize();
            } else {
                document.getElementById('map-view').classList.add('hidden');
                document.getElementById('camera-view').classList.remove('hidden');
                startCamera();
            }
        }

        function toggleARViewMode() {
            arViewMode = (arViewMode === 'realworld') ? 'indicator' : 'realworld';
            document.getElementById('ar-view-mode-text').textContent = arViewMode === 'realworld' ? 'Tampilan AR: Dunia Nyata' : 'Tampilan AR: Indikator';
            updateARObjects(lastNearbyContent);
        }

        function toggleDebugInfo() {
            const dbg = document.getElementById('debug-info');
            if (dbg) dbg.classList.toggle('hidden');
        }

        // -----------------------
        // --- MENU + OPEN FROM MENU (PERMINTAAN KAMU) ---
        // -----------------------

        // Save / load openedBoxes
        function saveOpenedBoxes() {
            try {
                localStorage.setItem('openedBoxes', JSON.stringify(Array.from(openedBoxes)));
            } catch (e) {
                console.warn('Gagal menyimpan openedBoxes', e);
            }
        }

        function loadOpenedBoxes() {
            try {
                const raw = localStorage.getItem('openedBoxes');
                if (raw) {
                    const arr = JSON.parse(raw);
                    openedBoxes = new Set(arr);
                } else {
                    openedBoxes = new Set();
                }
            } catch (e) {
                console.warn('Gagal membaca openedBoxes', e);
                openedBoxes = new Set();
            }
        }

        // Update the content list modal: show ALL contents, with tombol "Buka" yang selalu aktif
        function updateNearbyContentList(nearbyContent) {
            const listEl = document.getElementById('nearby-content-list');
            if (!listEl) return;
            listEl.innerHTML = '';

            if (!arContents || arContents.length === 0) {
                listEl.innerHTML = `<div class="text-center py-8 text-gray-500">Tidak ada konten AR</div>`;
                return;
            }

            const items = arContents.map(c => {
                const dist = (currentPosition && typeof c.lat === 'number' && typeof c.lng === 'number')
                    ? Math.round(calculateDistance(currentPosition.lat, currentPosition.lng, c.lat, c.lng))
                    : null;
                return Object.assign({}, c, { _computedDistance: dist });
            });

            items.sort((a,b) => {
                if (a._computedDistance === null) return 1;
                if (b._computedDistance === null) return -1;
                return a._computedDistance - b._computedDistance;
            });

            items.forEach(content => {
                const isOpened = openedBoxes.has(content.id);

                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-3 border-b border-gray-100';

                const left = document.createElement('div');
                left.className = 'flex flex-col';

                const title = document.createElement('div');
                title.className = 'font-medium text-sm text-gray-800';
                title.textContent = content.title || 'Untitled';

                const sub = document.createElement('div');
                sub.className = 'text-xs text-gray-500';
                const typeText = content.type ? content.type.toUpperCase() : 'N/A';
                const distText = content._computedDistance !== null ? ` ‚Ä¢ ${content._computedDistance} m` : '';
                sub.textContent = `${typeText}${distText}`;

                left.appendChild(title);
                left.appendChild(sub);

                const right = document.createElement('div');
                right.className = 'flex items-center gap-2';

                const previewBtn = document.createElement('button');
                previewBtn.className = 'text-xs px-3 py-1 rounded-md border';
                previewBtn.textContent = 'Lihat';
                previewBtn.onclick = () => {
                    if (typeof showARContent === 'function') {
                        showARContent(content);
                    } else {
                        alert(`${content.title}\n\n${content.description || ''}`);
                    }
                };

                const openBtn = document.createElement('button');
                openBtn.className = 'text-xs px-3 py-1 rounded-md bg-blue-600 text-white';
                openBtn.textContent = isOpened ? 'Sudah Dibuka' : 'Buka';
                openBtn.disabled = isOpened;
                openBtn.onclick = () => {
                    revealContentFromMenu(content.id);
                };

                right.appendChild(previewBtn);
                right.appendChild(openBtn);

                row.appendChild(left);
                row.appendChild(right);
                listEl.appendChild(row);
            });
        }

        // Force open content from menu (ignores distance)
        function revealContentFromMenu(contentId) {
            const content = arContents.find(c => c.id === contentId);
            if (!content) {
                alert('Konten tidak ditemukan.');
                return;
            }

            openedBoxes.add(content.id);
            saveOpenedBoxes();

            // Prefer showARContent which shows the content in modal
            if (typeof showARContent === 'function') {
                showARContent(content);
            } else {
                alert(`Membuka: ${content.title}`);
            }

            updateNearbyContentList(lastNearbyContent || []);
            if (studentMap) updateStudentMapMarkers();
            updateARObjects(lastNearbyContent || []);
        }

        // Show/hide content list modal
        function showContentList() {
            const modal = document.getElementById('content-list-modal');
            if (!modal) return;
            modal.classList.remove('hidden');
            updateNearbyContentList(lastNearbyContent || []);
        }
        function hideContentList() {
            const modal = document.getElementById('content-list-modal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        // -----------------------
        // Show content viewer and openTreasureBox implementation
        // -----------------------
        function showARContent(content) {
            if (!content) return;
            const viewer = document.getElementById('content-viewer');
            const titleEl = document.getElementById('viewer-title');
            const bodyEl = document.getElementById('viewer-body');
            titleEl.textContent = content.title || 'Konten AR';
            bodyEl.innerHTML = '';

            // Build content depending on type
            if (content.type === 'image') {
                const img = document.createElement('img');
                img.src = content.content;
                img.alt = content.title;
                img.style.maxWidth = '100%';
                bodyEl.appendChild(img);
                if (content.description) {
                    const p = document.createElement('p');
                    p.className = 'mt-3 text-sm text-gray-700';
                    p.textContent = content.description;
                    bodyEl.appendChild(p);
                }
            } else if (content.type === '3d') {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<model-viewer src="${content.content}" alt="${content.title}" auto-rotate camera-controls ar ar-modes="webxr scene-viewer quick-look" style="width:100%;height:400px;"></model-viewer>`;
                bodyEl.appendChild(wrapper);
            } else if (content.type === 'video') {
                // embed youtube
                const iframe = document.createElement('iframe');
                iframe.width = '100%';
                iframe.height = '400';
                iframe.src = `https://www.youtube.com/embed/${content.content}`;
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                bodyEl.appendChild(iframe);
                if (content.description) {
                    const p = document.createElement('p');
                    p.className = 'mt-3 text-sm text-gray-700';
                    p.textContent = content.description;
                    bodyEl.appendChild(p);
                }
            } else if (content.type === 'presentation') {
                let slides = [];
                try { slides = JSON.parse(content.content); } catch(e) { slides = []; }
                slides.forEach(s => {
                    const img = document.createElement('img');
                    img.src = s;
                    img.style.maxWidth = '100%';
                    img.className = 'mb-3';
                    bodyEl.appendChild(img);
                });
                if (content.description) {
                    const p = document.createElement('p');
                    p.className = 'mt-3 text-sm text-gray-700';
                    p.textContent = content.description;
                    bodyEl.appendChild(p);
                }
            } else {
                const p = document.createElement('p');
                p.textContent = content.description || 'Tidak ada preview untuk konten ini.';
                bodyEl.appendChild(p);
            }

            viewer.classList.remove('hidden');
        }

        function closeContentViewer() {
            const viewer = document.getElementById('content-viewer');
            if (!viewer) return;
            viewer.classList.add('hidden');
        }

        // openTreasureBox: triggered by AR open button in scene. It will mark opened and show content
        function openTreasureBox(contentId) {
            const content = arContents.find(c => c.id === contentId);
            if (!content) {
                alert('Konten tidak ditemukan.');
                return;
            }

            // If you want to enforce distance in AR open: check here
            if (currentPosition) {
                const dist = calculateDistance(currentPosition.lat, currentPosition.lng, content.lat, content.lng);
                if (dist > boxOpenDistance) {
                    alert(`Anda masih terlalu jauh (${Math.round(dist)}m). Dekati hingga ${boxOpenDistance}m atau buka lewat menu.`);
                    return;
                }
            }

            openedBoxes.add(content.id);
            saveOpenedBoxes();
            showARContent(content);
            updateNearbyContentList(lastNearbyContent || []);
            updateARObjects(lastNearbyContent || []);
        }

        // Helper: extract youtube ID
        function extractYouTubeID(url) {
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) return match[2];
            return url;
        }

        // -----------------------
        // Small helpers & finishing
        // -----------------------
        function toggleViewDebug() { const dbg = document.getElementById('debug-info'); if (dbg) dbg.classList.toggle('hidden'); }

        // Start by getting one location fix (optional)
        setTimeout(() => {
            // try get permission and current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
                }, err=>{ /* ignore */ }, { enableHighAccuracy: true, timeout: 5000 });
            }
        }, 1000);
    </script>
</body>
</html>
