<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Scan â€” Futuristic</title>
<style>
  :root{--accent:#00fff6;--accent2:#7c4dff;--bg:#050308}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6f7ff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #webcam-container{position:relative;width:100%;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center}
  #webcam-container canvas, #webcam-container video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  /* label panel */
  #label-container{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:60;display:flex;gap:8px;flex-direction:column;align-items:center}
  #label-container div{background:linear-gradient(180deg, rgba(0,0,0,0.48), rgba(0,0,0,0.28));padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);font-weight:700}
  .rethink-glow{color:var(--accent);text-shadow:0 0 10px var(--accent),0 0 22px var(--accent2);animation:pulse 1.2s infinite alternate}
  @keyframes pulse{from{opacity:0.75}to{opacity:1}}

  /* holo text */
  #holo-text{position:fixed;top:12%;left:50%;transform:translateX(-50%);z-index:62;font-size:28px;font-weight:900;color:var(--accent);opacity:0;pointer-events:none}
  @keyframes holoFade{0%{opacity:0;transform:translateX(-50%) translateY(-12px)}30%{opacity:1;transform:translateX(-50%) translateY(0)}70%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(12px)}}

  /* glass morph overlay for choices - does NOT stop scanning */
  .choice-backdrop{position:fixed;inset:8% 6% 12% 6%;display:none;align-items:center;justify-content:center;z-index:65}
  .choice-backdrop.show{display:flex}
  .choice-card{width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(10,8,16,0.18));backdrop-filter:blur(10px) saturate(140%);border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.04);display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .choice-card .cbtn{background:transparent;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .choice-card .cbtn:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,0.5)}

  /* embedded iframe */
  #iframe-container{position:fixed;inset:6% 6% 8% 6%;z-index:68;display:none}
  .embed-wrap{width:100%;height:100%;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
  .embed-wrap iframe{width:100%;height:100%;border:0}

  /* start button */
  #startBtn{position:fixed;left:14px;bottom:14px;z-index:70;padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent2),var(--accent));color:#001;cursor:pointer;font-weight:800}

  /* small responsive */
  @media (max-width:640px){ #holo-text{font-size:18px} .choice-card{grid-template-columns:repeat(1,1fr)} }
</style>
</head>
<body>
  <div id="webcam-container"></div>

  <div id="label-container" aria-live="polite"></div>
  <div id="holo-text">Re-Think detected!</div>

  <!-- glass overlay choices (does not stop scanning) -->
  <div id="choice-panel" class="choice-backdrop" role="dialog" aria-modal="false">
    <div class="choice-card" role="menu">
      <button class="cbtn" data-url="https://data.ntbprov.go.id/dataset/9e32ffc2-f4e3-44e1-ba78-845ecb86ba66/show">APK</button>
      <button class="cbtn" data-url="https://suarantb.com/2024/11/18/peringkat-ipm-2024-kota-mataram-masih-tertinggi-klu-belum-bergeser-dari-posisi-terbawah/">IPM</button>
      <button class="cbtn" data-url="https://www.detik.com/bali/nusra/d-7996587/stunting-di-mataram-turun-jadi-6-6-persen-pemkot-bidik-di-bawah-5-persen">Stunting</button>
    </div>
  </div>

  <!-- iframe container shown when user chooses an item (pauses prediction loop) -->
  <div id="iframe-container" aria-hidden="true"><div class="embed-wrap"></div></div>

  <button id="startBtn">Start Scan</button>

  <!-- libs (ensure tmImage global is available) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // Configuration
    const MODEL_BASE = 'https://teachablemachine.withgoogle.com/models/OEXYCpyXs/';
    const CLASS1_LABEL = 'Class 1';
    const CLASS2_LABEL = 'Class 2';
    const CLASS1_DISPLAY = 'Other';
    const CLASS2_DISPLAY = 'Re-Think';

    // Elements
    const webcamContainer = document.getElementById('webcam-container');
    const labelContainer = document.getElementById('label-container');
    const choicePanel = document.getElementById('choice-panel');
    const iframeContainer = document.getElementById('iframe-container');
    const embedWrap = iframeContainer.querySelector('.embed-wrap');
    const holoText = document.getElementById('holo-text');
    const startBtn = document.getElementById('startBtn');

    // State
    let model = null;
    let maxPredictions = 0;
    let webcam = null;
    let running = false;
    let rafId = null;
    let choiceShown = false;

    // Load model (guard if tmImage not present)
    async function loadModel(){
      if(typeof window.tmImage === 'undefined'){
        throw new Error('Library tmImage tidak tersedia. Pastikan script teachablemachine-image.min.js berhasil dimuat.');
      }
      const modelURL = MODEL_BASE + 'model.json';
      const metadataURL = MODEL_BASE + 'metadata.json';
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
    }

    async function startCamera(){
      // use tmImage.Webcam helper if available
      if(typeof tmImage.Webcam === 'function'){
        webcam = new tmImage.Webcam(640,480,true);
        await webcam.setup();
        await webcam.play();
        webcamContainer.appendChild(webcam.canvas);
      }else{
        // fallback to getUserMedia -> create video + canvas
        const v = document.createElement('video');
        v.setAttribute('playsinline',''); v.autoplay = true; v.muted = true;
        try{
          const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
          v.srcObject = stream; await v.play();
          // create canvas wrapper so model.predict can use canvas element
          const c = document.createElement('canvas');
          c.width = v.videoWidth || 640; c.height = v.videoHeight || 480;
          const ctx = c.getContext('2d');
          // attach one frame updater that the loop will draw into
          webcam = { video: v, canvas: c, ctx: ctx, update: ()=>{ c.width = v.videoWidth || c.width; c.height = v.videoHeight || c.height; ctx.drawImage(v,0,0,c.width,c.height); }, play: ()=>{}, stop: ()=>{ (v.srcObject && v.srcObject.getTracks().forEach(t=>t.stop())); } };
          webcamContainer.appendChild(v);
          // keep canvas hidden but attached for model.predict
          c.style.display = 'none'; webcamContainer.appendChild(c);
        }catch(e){ throw new Error('Gagal mengakses kamera: ' + (e.message||e)); }
      }
    }

    function renderLabels(preds){
      labelContainer.innerHTML = '';
      for(let i=0;i<preds.length;i++){
        const p = preds[i];
        let disp = p.className;
        let cls = '';
        if(p.className === CLASS2_LABEL){ disp = CLASS2_DISPLAY; cls = 'rethink-glow'; }
        if(p.className === CLASS1_LABEL){ disp = CLASS1_DISPLAY; }
        const div = document.createElement('div');
        div.className = cls;
        div.innerHTML = `${disp}: ${(p.probability*100).toFixed(1)}%`;
        labelContainer.appendChild(div);
      }
    }

    async function predictFrame(){
      if(!model || !webcam) return;
      // ensure webcam has latest frame
      if(typeof webcam.update === 'function') webcam.update();
      const canvasEl = webcam.canvas;
      try{
        const preds = await model.predict(canvasEl);
        renderLabels(preds);
        // check class2 raw probability
        const rawClass2 = preds.find(x=>x.className === CLASS2_LABEL);
        if(rawClass2 && rawClass2.probability >= 0.5 && !choiceShown){
          choiceShown = true;
          // show glass overlay but do NOT stop scanning
          choicePanel.classList.add('show');
          // trigger holo text animation
          holoText.style.animation = 'none'; void holoText.offsetWidth; holoText.style.animation = 'holoFade 3s ease-out';
        }
      }catch(e){
        console.warn('Predict error', e);
      }
    }

    async function loop(){
      if(!running) return;
      await predictFrame();
      rafId = requestAnimationFrame(loop);
    }

    async function startScan(){
      try{
        startBtn.disabled = true; startBtn.textContent = 'Loading model...';
        await loadModel();
        startBtn.textContent = 'Starting camera...';
        await startCamera();
        running = true;
        startBtn.style.display = 'none';
        // kick off continuous loop
        rafId = requestAnimationFrame(loop);
      }catch(err){
        console.error(err);
        alert(err.message || err);
        startBtn.disabled = false; startBtn.textContent = 'Start Scan';
      }
    }

    function pausePredictions(){ running = false; if(rafId) cancelAnimationFrame(rafId); }
    function resumePredictions(){ if(!running){ running = true; rafId = requestAnimationFrame(loop); } }

    // wire choice buttons -> open embedded iframe and pause predictions while embedded
    choicePanel.querySelectorAll('.cbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const url = btn.dataset.url;
        if(!url) return;
        // show embed
        embedWrap.innerHTML = '';
        const ifr = document.createElement('iframe');
        ifr.src = url;
        embedWrap.appendChild(ifr);
        iframeContainer.style.display = 'block'; iframeContainer.setAttribute('aria-hidden','false');
        // pause prediction loop (so CPU less busy) but keep camera playing
        pausePredictions();
        // hide overlay visually
        choicePanel.classList.remove('show');
      });
    });

    // close embedded on ESC or click outside iframe
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && iframeContainer.style.display==='block'){ embedWrap.innerHTML=''; iframeContainer.style.display='none'; iframeContainer.setAttribute('aria-hidden','true'); resumePredictions(); }});
    iframeContainer.addEventListener('click', e=>{ if(e.target === iframeContainer){ embedWrap.innerHTML=''; iframeContainer.style.display='none'; resumePredictions(); }});

    // clicking backdrop of choicePanel should just hide overlay (scanning continues)
    choicePanel.addEventListener('click', e=>{ if(e.target === choicePanel){ choicePanel.classList.remove('show'); } });

    // start button
    startBtn.addEventListener('click', startScan);

    // helpful console message if tmImage missing
    if(typeof window.tmImage === 'undefined') console.warn('tmImage not defined â€” ensure teachablemachine-image script loaded.');
  </script>
</body>
</html>
