<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Re-Think – Mataram HARUM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
    #student-map { height: 100%; width: 100%; border-radius: 12px; }
    .camera-feed { position: relative; overflow: hidden; border-radius: 12px; background-color: #000; }
    .camera-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; perspective: 1000px; transform-style: preserve-3d; }
    .ar-object { position: absolute; transform-style: preserve-3d; pointer-events: auto; transition: opacity .3s ease; }
    .ar-label { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); background: rgba(37,99,235,.9); color: #fff; padding: 4px 10px; border-radius: 14px; font-size: 12px; white-space: nowrap; }
    .ar-distance { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.6); color:#fff; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    .top-controls{ position:absolute; top:20px; right:20px; z-index:1000; display:flex; gap:10px; }
    .control-btn{ background:#fff; border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 10px rgba(0,0,0,.1); cursor:pointer; }
    .compass{ position:absolute; top:80px; left:20px; z-index:900; background:#fff; border-radius:50%; width:60px; height:60px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .needle{ position:absolute; width:4px; height:24px; background:linear-gradient(to bottom,#dc2626 50%, #1d4ed8 50%); transform-origin:center; transition:transform .3s ease; }
    .direction-arrow{ position:absolute; bottom:100px; left:50%; transform:translateX(-50%); width:60px; height:60px; background:rgba(37,99,235,.9); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:20; box-shadow:0 4px 6px rgba(0,0,0,.1) }
    .dart{ width:30px; height:30px; border-top:6px solid #fff; border-right:6px solid #fff; transform-origin:center; }
    model-viewer{ width:100%; height:300px; background:#f3f4f6; --poster-color:#f3f4f6; }
    .embed-card{ width:280px; height:180px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; }
    .embed-card iframe{ width:100%; height:100%; border:0; }
    .embed-card img{ max-width:100%; max-height:100%; display:block; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen">
    <div id="loading" class="min-h-screen flex flex-col items-center justify-center p-6 text-white" style="background:linear-gradient(135deg,#3b82f6 0%, #2563eb 100%)">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-2">Re-Think</h1>
        <p class="text-xl opacity-90">Memuat konten AR…</p>
      </div>
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-300 border-t-blue-600 mb-3"></div>
      <p id="load-status" class="text-lg opacity-80">Mengambil data dari server…</p>
    </div><div id="student" class="hidden min-h-screen bg-gray-100">
  <!-- Camera view -->
  <div class="relative h-screen">
    <div class="camera-feed h-full w-full">
      <video id="cam" class="h-full w-full object-cover" autoplay playsinline></video>
      <div id="overlay" class="camera-overlay"></div>

      <div class="top-controls">
        <div class="control-btn" onclick="toggleView('map')" title="Lihat Peta">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
        </div>
        <div class="control-btn" onclick="showContentList()" title="Daftar Konten">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </div>
      </div>

      <div class="compass"><div id="needle" class="needle"></div><div style="width:10px;height:10px;border:2px solid #6b7280;border-radius:50%"></div></div>
      <div class="direction-arrow"><div id="dart" class="dart"></div></div>
      <div id="closest" class="absolute bottom-20 left-0 right-0 text-center text-white text-lg font-semibold">Mencari konten terdekat…</div>
    </div>
  </div>

  <!-- Map view -->
  <div id="mapwrap" class="hidden h-screen relative">
    <div id="student-map"></div>
    <!-- Tombol kembali (lebih besar) -->
    <div class="absolute top-4 left-4 z-50">
      <button onclick="toggleView('camera')" class="bg-white rounded-full w-14 h-14 shadow flex items-center justify-center active:scale-95" title="Kembali ke Kamera">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
    </div>
    <!-- Tombol center ke lokasi saya -->
    <div class="absolute bottom-24 right-4 z-50">
      <button id="btn-center" class="bg-white rounded-full w-12 h-12 shadow flex items-center justify-center active:scale-95" title="Ke Lokasi Saya">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
    </div>
    <!-- Tombol besar tutup peta di bawah -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-50">
      <button onclick="toggleView('camera')" class="px-5 py-3 rounded-full bg-indigo-600 text-white shadow-lg text-sm font-medium active:scale-95">Tutup Peta</button>
    </div>
  </div>
    <div class="absolute top-4 left-4 z-50">
      <button onclick="toggleView('camera')" class="bg-white rounded-full w-12 h-12 shadow flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
    </div>
    <div class="absolute bottom-4 right-4 z-50">
      <button id="btn-center" class="bg-white rounded-full w-12 h-12 shadow flex items-center justify-center" title="Ke Lokasi Saya">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </button>
    </div>
  </div>

  <!-- Modal daftar konten -->
  <div id="modal-list" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
    <div class="bg-white rounded-t-xl w-full max-w-md max-h-[70vh] overflow-hidden">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold">Konten AR</h3>
        <button onclick="hideContentList()" class="text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="nearby-list" class="p-4 space-y-3 overflow-y-auto"></div>
    </div>
  </div>
</div>

  </div>  <script>
    // ==== Variabel global ====
    let arContents = [];
    let currentPosition = null;
    let studentMap = null;
    let currentHeading = 0;
    let deviceOrientation = { alpha:0, beta:0, gamma:0 };
    let targetARContent = null;
    let arObjects = [];

    // ==== Init ====
    init();

    function init(){
      document.getElementById('loading').classList.remove('hidden');
      loadCSV();
      if (window.DeviceOrientationEvent){
        window.addEventListener('deviceorientation', onOrientation);
      }
    }

    // ==== Load data dari Google Sheets ====
    async function loadCSV(){
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3gcrsiBqijSgAqWi01ux417lYWx-JlMDlDeWI_qgrGU1FU7LKc5xL6xmKmGgSUj_UCucrug7M4ZBz/pub?gid=0&single=true&output=csv';
      try{
        const res = await fetch(csvUrl); if(!res.ok) throw new Error(res.status);
        const text = await res.text();
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
        const nameIndex = headers.findIndex(h=>h.includes('name')||h.includes('title')||h.includes('nama'));
        const latIndex = headers.findIndex(h=>h.includes('lat'));
        const lonIndex = headers.findIndex(h=>h.includes('lon')||h.includes('lng'));
        const urlIndex = headers.findIndex(h=>h.includes('url'));
        const descIndex = urlIndex+1;
        arContents = [];
        for(let i=1;i<lines.length;i++){
          const row = lines[i].split(',').map(c=>c.trim());
          if(row.length >= Math.max(nameIndex,latIndex,lonIndex,urlIndex)+1){
            const name=row[nameIndex]; const lat=parseFloat(row[latIndex]); const lng=parseFloat(row[lonIndex]); const url=row[urlIndex]; const description=row[descIndex]||'';
            if(name && !isNaN(lat) && !isNaN(lng) && url){
              let type='embed'; let content=url;
              if(/(youtube\.com|youtu\.be)/i.test(url)){ type='video'; content=extractYouTubeID(url); }
              else if(/\.(glb|gltf)$/i.test(url)){ type='3d'; }
              else if(url.includes(',')){ type='presentation'; content=JSON.stringify(url.split(',').map(u=>u.trim()).filter(Boolean)); }
              else if(/\.(png|jpe?g|gif|webp|svg)$/i.test(url)){ type='image'; }
              arContents.push({ id:`csv_${i}_${Date.now()}`, title:name, type, content, description, lat, lng, radius: 50, height:1.5, anchorType:'fixed', scale:1, rotation:0 });
            }
          }
        }
        localStorage.setItem('arContents', JSON.stringify(arContents));
        startStudent();
      }catch(e){
        const cached = localStorage.getItem('arContents');
        if(cached){ arContents = JSON.parse(cached); startStudent(); }
        else{ document.getElementById('load-status').textContent='Gagal memuat data.'; }
      }
    }

    function startStudent(){
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('student').classList.remove('hidden');
      startCamera();
      initMap();
      trackLocation();
      requestAnimationFrame(loop);
    }

    // ==== Kamera ====
    function startCamera(){
      if(navigator.mediaDevices?.getUserMedia){
        navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
          .then(stream=>{ document.getElementById('cam').srcObject=stream; })
          .catch(()=>alert('Izinkan akses kamera untuk AR.'));
      }
    }

    // ==== Peta ====
    function initMap(){
      studentMap = L.map('student-map').setView([0,0], 18);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(studentMap);
      document.getElementById('btn-center').addEventListener('click',()=>{ if(currentPosition){ studentMap.setView([currentPosition.lat,currentPosition.lng],18); } });
      // Gestur & pintasan gampang
      const mapwrap = document.getElementById('mapwrap');
      // Tutup dengan double-tap/double-click
      mapwrap.addEventListener('dblclick', ()=> toggleView('camera'));
      mapwrap.addEventListener('touchend', onTouchEndClose, {passive:true});
      // ESC atau tombol C untuk kembali
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' || e.key.toLowerCase()==='c'){ if(!document.getElementById('mapwrap').classList.contains('hidden')) toggleView('camera'); } });
    }.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(studentMap);
      document.getElementById('btn-center').addEventListener('click',()=>{ if(currentPosition){ studentMap.setView([currentPosition.lat,currentPosition.lng],18); } });
    }

    function updateMap(){
      if(!studentMap || !currentPosition) return;
      // hapus marker & circle lama
      const toRemove=[]; studentMap.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.Circle || l instanceof L.Polyline) toRemove.push(l); });
      toRemove.forEach(l=>studentMap.removeLayer(l));
      // posisi saya
      L.marker([currentPosition.lat,currentPosition.lng],{ icon:L.divIcon({ className:'', html:'<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white"></div>', iconSize:[20,20], iconAnchor:[10,10] }) }).addTo(studentMap);
      L.circle([currentPosition.lat,currentPosition.lng],{ radius: currentPosition.accuracy||10, color:'#3b82f6', fillColor:'#3b82f6', fillOpacity:.1, weight:1 }).addTo(studentMap);
      // konten
      arContents.forEach(c=>{
        const m=L.marker([c.lat,c.lng],{ icon:L.divIcon({ className:'', html:`<div class='w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white'>${iconFor(c.type)}</div>`, iconSize:[24,24], iconAnchor:[12,12] }) }).addTo(studentMap);
        L.circle([c.lat,c.lng],{ radius:c.radius, color:'#4f46e5', fillColor:'#4f46e5', fillOpacity:.08, weight:1 }).addTo(studentMap);
        m.on('click',()=>{ targetARContent=c; updateArrow(); toggleView('camera'); });
      });
      if(targetARContent){ L.polyline([[currentPosition.lat,currentPosition.lng],[targetARContent.lat,targetARContent.lng]],{ color:'#4f46e5', weight:3, dashArray:'5,10', opacity:.8 }).addTo(studentMap); }
    }

    // ==== Lokasi & orientasi ====
    function trackLocation(){
      if(!navigator.geolocation) return alert('Geolokasi tidak didukung');
      navigator.geolocation.watchPosition(pos=>{
        const { latitude, longitude, accuracy } = pos.coords;
        currentPosition = { lat:latitude, lng:longitude, accuracy };
        checkContents();
        updateMap();
      }, err=>console.log(err), { enableHighAccuracy:true, maximumAge:0, timeout:8000 });
    }

    function onOrientation(e){
      if(e.alpha!=null){ currentHeading = (e.alpha)%360; document.getElementById('needle').style.transform=`rotate(${currentHeading}deg)`; updateArrow(); }
      deviceOrientation = { alpha:e.alpha||0, beta:e.beta||0, gamma:e.gamma||0 };
    }

    function updateArrow(){
      if(!currentPosition || !targetARContent) return;
      const b = bearing(currentPosition.lat,currentPosition.lng,targetARContent.lat,targetARContent.lng);
      const rel = (b - currentHeading + 360)%360;
      document.getElementById('dart').style.transform = `rotate(${rel-45}deg)`;
    }

    // ==== Logika sesuai permintaan ====
    // 1) Tidak disembunyikan dalam kotak -> selalu tampilkan konten
    // 2) Bisa dibuka dalam radius berapapun -> abaikan cek radius; tetap render & bisa dibuka dari jauh
    function checkContents(){
      if(!currentPosition) return;
      // hitung jarak & simpan untuk sort/label
      arContents.forEach(c=>{ c.distance = distance(currentPosition.lat,currentPosition.lng,c.lat,c.lng); });
      // target default = terdekat
      arContents.sort((a,b)=>a.distance-b.distance);
      const closest = arContents[0];
      document.getElementById('closest').textContent = closest ? `${closest.title}: ${Math.round(closest.distance)}m` : 'Tidak ada konten';
      if(!targetARContent && closest) targetARContent = closest;
    }

    // Render loop AR
    function loop(){ renderAR(); requestAnimationFrame(loop); }

    function renderAR(){
      if(!currentPosition) return;
      const overlay = document.getElementById('overlay');
      overlay.innerHTML='';
      // tampilkan SEMUA konten (tanpa pembatas radius), tapi hanya yang berada kira-kira di field-of-view 120°
      arContents.forEach(c=>{
        const b = bearing(currentPosition.lat,currentPosition.lng,c.lat,c.lng);
        const rel = (b - currentHeading + 360)%360;
        if(rel<60 || rel>300){
          const el = document.createElement('div'); el.className='ar-object';
          const viewportX = rel<60 ? 50 + (rel/60)*40 : 50 - ((360-rel)/60)*40;
          const dist = c.distance || 1; const maxR = c.radius || 50;
          const distScale = 0.2 + (0.8 * (1 - Math.min(1, dist / maxR)));
          const tilt = deviceOrientation.beta||0; const y = 50 - ( (c.height||1.5)*3 ) - ((tilt-90)*0.3);
          el.style.left = `${Math.max(10, Math.min(90, viewportX))}%`;
          el.style.top  = `${Math.max(10, Math.min(80, y))}%`;
          const scale = (c.scale||1) * distScale; const rot=c.rotation||0;

          // === KONTEN ===
          const card = createContentElement(c);
          const label = document.createElement('div'); label.className='ar-label'; label.textContent=c.title;
          const dEl = document.createElement('div'); dEl.className='ar-distance'; dEl.textContent=`${Math.round(dist)}m`;

          el.style.transform = `translate(-50%,-50%) scale(${scale}) rotateZ(${rot}deg)`;
          el.appendChild(card); el.appendChild(label); el.appendChild(dEl);
          el.addEventListener('click',()=>showContentModal(c));
          overlay.appendChild(el);
        }
      });
    }

    // Buat elemen konten sesuai tipe; non‑GLB pakai EMBED (iframe) sesuai permintaan
    function createContentElement(c){
      if(c.type==='3d'){
        const wrap = document.createElement('div'); wrap.style.width='140px'; wrap.style.height='140px'; wrap.style.background='transparent';
        wrap.innerHTML = `<model-viewer src="${c.content}" alt="${c.title}" auto-rotate camera-controls shadow-intensity="1" ar ar-modes="webxr scene-viewer quick-look" touch-action="pan-y" style="width:100%;height:100%;background:transparent;"></model-viewer>`;
        return wrap;
      }
      // selain GLB -> iframe embed
      const card = document.createElement('div'); card.className='embed-card';
      if(c.type==='image'){
        // gambar bisa langsung ditaruh; tetap di dalam card
        const img = document.createElement('img'); img.src=c.content; img.alt=c.title; card.appendChild(img); return card;
      }
      if(c.type==='video'){
        const iframe = document.createElement('iframe'); iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share'; iframe.referrerPolicy='strict-origin-when-cross-origin'; iframe.allowFullscreen=true; iframe.src = `https://www.youtube.com/embed/${c.content}`; card.appendChild(iframe); return card;
      }
      if(c.type==='presentation'){
        const slides = JSON.parse(c.content);
        const iframe = document.createElement('iframe'); iframe.src = slides[0]; card.appendChild(iframe); return card;
      }
      // default: URL umum -> iframe
      const iframe = document.createElement('iframe'); iframe.src=c.content; card.appendChild(iframe); return card;
    }

    // Modal untuk membaca konten dengan ukuran lebih nyaman
    function showContentModal(c){
      const modal = document.getElementById('modal-list');
      const list = document.getElementById('nearby-list');
      list.innerHTML = '';
      // header item besar
      const big = document.createElement('div'); big.className='space-y-2';
      big.innerHTML = `<div class='text-base font-semibold'>${c.title}</div><div class='text-sm text-gray-600'>${c.description||''}</div>`;
      list.appendChild(big);
      const holder = document.createElement('div'); holder.className='mt-2 flex justify-center'; holder.appendChild(createContentElement(c)); list.appendChild(holder);

      // jika presentasi, tambahkan navigasi sederhana
      if(c.type==='presentation'){
        const slides = JSON.parse(c.content);
        const nav = document.createElement('div'); nav.className='flex items-center justify-between mt-3';
        const prev = document.createElement('button'); prev.className='px-3 py-2 rounded bg-indigo-600 text-white disabled:bg-gray-400'; prev.textContent='Sebelumnya'; prev.disabled=true;
        const next = document.createElement('button'); next.className='px-3 py-2 rounded bg-indigo-600 text-white disabled:bg-gray-400'; next.textContent='Berikutnya';
        const counter = document.createElement('span'); counter.className='text-sm text-gray-600'; counter.textContent = `1 / ${slides.length}`;
        const iframe = holder.querySelector('iframe');
        let idx=0; function update(){ iframe.src = slides[idx]; counter.textContent = `${idx+1} / ${slides.length}`; prev.disabled = idx===0; next.disabled = idx===slides.length-1; }
        prev.onclick=()=>{ if(idx>0){ idx--; update(); } };
        next.onclick=()=>{ if(idx<slides.length-1){ idx++; update(); } };
        nav.appendChild(prev); nav.appendChild(counter); nav.appendChild(next); list.appendChild(nav);
      }
      modal.classList.remove('hidden');
    }

    function showContentList(){
      const modal = document.getElementById('modal-list');
      const list = document.getElementById('nearby-list');
      list.innerHTML='';
      arContents.forEach(c=>{
        const item=document.createElement('div'); item.className='p-3 rounded border border-gray-200 hover:bg-gray-50 cursor-pointer';
        item.innerHTML=`<div class='font-medium'>${c.title}</div><div class='text-sm text-gray-600'>${c.description||''}</div><div class='text-xs text-gray-500 mt-1'>${Math.round(c.distance||0)} m</div>`;
        item.onclick=()=>{ targetARContent=c; showContentModal(c); };
        list.appendChild(item);
      });
      modal.classList.remove('hidden');
    }
    function hideContentList(){ document.getElementById('modal-list').classList.add('hidden'); }

    // ==== Utils ====
    let touchStartY=null, touchStartX=null; let touchEndY=null, touchEndX=null;
    function onTouchEndClose(ev){
      if(ev.changedTouches && ev.changedTouches[0]){
        if(touchStartY===null){ touchStartY = ev.changedTouches[0].clientY; touchStartX = ev.changedTouches[0].clientX; setTimeout(()=>{ touchStartY=null; touchStartX=null; }, 350); return; }
        touchEndY = ev.changedTouches[0].clientY; touchEndX = ev.changedTouches[0].clientX;
        const dy = touchEndY - touchStartY; const dx = Math.abs(touchEndX - touchStartX);
        // swipe turun minimal 60px dengan deviasi horizontal kecil
        if(dy > 60 && dx < 80){ toggleView('camera'); }
        touchStartY = null; touchStartX = null; touchEndY = null; touchEndX = null;
      }
    }
    function toggleView(v){ if(v==='map'){ document.getElementById('mapwrap').classList.remove('hidden'); document.getElementById('student').querySelector('.relative').classList.add('hidden'); updateMap(); } else { document.getElementById('mapwrap').classList.add('hidden'); document.getElementById('student').querySelector('.relative').classList.remove('hidden'); } }
    function iconFor(t){ return t==='text'?'T': t==='image'?'G': t==='3d'?'3D': t==='video'?'V': t==='presentation'?'P':'?'; }
    function extractYouTubeID(url){ if(/^[a-zA-Z0-9_-]{11}$/.test(url)) return url; const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (m&&m[2].length===11)?m[2]:url; }
    function distance(lat1,lon1,lat2,lon2){ const R=6371e3; const φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180; const dφ=(lat2-lat1)*Math.PI/180; const dλ=(lon2-lon1)*Math.PI/180; const a=Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }
    function bearing(lat1,lon1,lat2,lon2){ const φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180; const dλ=(lon2-lon1)*Math.PI/180; const y=Math.sin(dλ)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(dλ); let θ=Math.atan2(y,x)*180/Math.PI; return (θ+360)%360; }
  </script></body>
</html>
