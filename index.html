<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoAR Learning ‚Äî Full</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

    <style>
        /* --- Styles (kept rich like original) --- */
        body{font-family:'Poppins',sans-serif;background:#f0f9ff;overflow-x:hidden}
        .mode-selection{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)}
        .camera-feed{position:relative;overflow:hidden;border-radius:12px;background:#000}
        .camera-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}
        #teacher-map,#student-map{height:100%;width:100%;border-radius:12px}
        .back-button,.control-button,.map-control-button,.location-button{position:absolute;background:white;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);cursor:pointer}
        .back-button{top:20px;left:20px;z-index:1000}
        .top-controls{position:absolute;top:20px;right:20px;z-index:1000;display:flex;gap:10px}
        .compass-container{position:absolute;top:80px;left:20px;z-index:900;background:white;border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .compass-needle{position:absolute;width:4px;height:24px;background:linear-gradient(to bottom,#dc2626 50%,#1d4ed8 50%);transform-origin:center;transition:transform .3s}
        .debug-info{position:absolute;bottom:160px;left:10px;background:rgba(255,255,255,0.9);padding:6px;border-radius:8px;z-index:900;font-size:12px}
        .ar-indicator{position:absolute;padding:8px 12px;border-radius:20px;background:rgba(37,99,235,0.9);color:white;z-index:20;pointer-events:auto}
        .ar-object{position:absolute;transform-style:preserve-3d;pointer-events:auto;transition:all .25s}
        .ar-object-presentation{width:320px;height:220px;border-radius:8px;overflow:hidden;background:#fff;border:1px solid #e5e7eb}
        .ar-object-image{max-width:300px;max-height:300px;border-radius:10px}
        .ar-object-video{width:320px;height:200px;background:#000;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff}
        model-viewer{width:100%;height:300px;background:#f3f4f6}
        .treasure-box{width:80px;height:80px;background:linear-gradient(45deg,#8B4513,#D2691E);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:28px}
        .open-box-button{position:absolute;bottom:-36px;left:50%;transform:translateX(-50%);background:linear-gradient(45deg,#FFD700,#FFA500);color:#8B4513;border-radius:20px;padding:8px 12px;border:none;cursor:pointer}
        .coordinate-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;z-index:2000}
        .spinner{width:40px;height:40px;border:4px solid rgba(59,130,246,0.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- Loading -->
        <div id="loading-screen" class="mode-selection min-h-screen flex flex-col items-center justify-center p-6 text-white">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold mb-2">GeoAR Learning</h1>
                <p class="text-xl opacity-90">Memuat konten AR...</p>
            </div>
            <div class="spinner mb-4"></div>
            <p id="loading-status" class="text-lg opacity-80">Mengambil data dari server...</p>
        </div>

        <!-- Student Mode -->
        <div id="student-mode" class="hidden min-h-screen bg-gray-100">
            <div id="camera-view" class="relative h-screen">
                <div class="camera-feed h-full w-full">
                    <video id="camera-feed" class="h-full w-full object-cover" autoplay playsinline></video>
                    <div class="camera-overlay" id="ar-overlay"></div>

                    <div class="back-button" onclick="location.reload()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </div>

                    <div class="top-controls">
                        <div class="control-button" onclick="toggleView('map')" title="Peta">
                            üìç
                        </div>
                        <div class="control-button" onclick="showContentList()" title="Daftar Konten">
                            üìÑ
                        </div>
                        <div class="control-button" onclick="toggleDebugInfo()" title="Debug">
                            ‚ÑπÔ∏è
                        </div>
                    </div>

                    <div class="compass-container">
                        <div class="compass-needle" id="compass-needle"></div>
                    </div>

                    <div class="direction-arrow" id="direction-arrow" style="position:absolute;bottom:100px;left:50%;transform:translateX(-50%);z-index:20;">
                        <div class="arrow" id="arrow" style="width:30px;height:30px;border-top:6px solid white;border-right:6px solid white;transform:rotate(45deg);"></div>
                    </div>

                    <div class="absolute bottom-20 left-0 right-0 text-center text-white text-lg font-semibold" id="distance-indicator">Mencari konten terdekat...</div>

                    <div class="debug-info hidden" id="debug-info">Arah: 0¬∞<br>Target: N/A<br>Bearing: N/A</div>

                    <div class="ar-view-mode-toggle" style="position:absolute;bottom:20px;left:20px;z-index:1000;background:white;padding:8px 12px;border-radius:20px;cursor:pointer;color:#2563eb;font-weight:600;" onclick="toggleARViewMode()">
                        <span id="ar-view-mode-text">Tampilan AR: Dunia Nyata</span>
                    </div>
                </div>

                <div class="absolute top-80 right-4 z-1000">
                    <button onclick="showCalibration()" class="bg-white text-blue-600 px-3 py-2 rounded-lg shadow-md text-sm">üìç Kalibrasi</button>
                </div>
            </div>

            <div id="map-view" class="hidden h-screen relative">
                <div id="student-map" class="h-full w-full"></div>
                <div class="back-button" onclick="toggleView('camera')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg></div>
                <div class="map-control-button" style="top:20px;right:80px;" onclick="toggleView('camera')">üì∑</div>
                <div class="location-button" id="student-use-current-location" title="Gunakan lokasi saya" style="bottom:20px;right:20px;">üìå</div>
            </div>

            <!-- Content List Modal -->
            <div id="content-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end justify-center">
                <div class="bg-white rounded-t-xl w-full max-w-md max-h-[70vh] overflow-hidden">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Konten AR Terdekat</h3>
                        <button onclick="hideContentList()" class="text-gray-500">‚úï</button>
                    </div>
                    <div class="content-list p-4" id="nearby-content-list"><div class="text-center py-8 text-gray-500">Tidak ada konten AR terdekat</div></div>
                </div>
            </div>

            <!-- Calibration Overlay -->
            <div id="calibration-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;padding:20px;text-align:center;">
                <h2 class="text-2xl font-bold mb-2">Kalibrasi Kompas Anda</h2>
                <p class="mb-4">Untuk posisi AR yang akurat, silakan putar perangkat Anda dalam pola angka 8</p>
                <div style="width:200px;height:200px;position:relative;margin:20px 0;"><div style="width:80px;height:140px;background:#3b82f6;border-radius:10px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);animation:rotate-phone 4s infinite ease-in-out"></div></div>
                <p class="mb-6">Terus putar hingga animasi selesai</p>
                <button onclick="finishCalibration()" style="background:#2563eb;padding:8px 16px;border-radius:8px;color:white">Saya Sudah Selesai Kalibrasi</button>
            </div>
        </div>

    </div>

<script>
/* =====================================
   Full-featured script: parsing CSV, maps, camera, AR rendering
   Added: treat unknown URLs as 'web' and render via iframe with fallback
   ===================================== */

let currentMode = null;
let studentMap = null;
let studentMapInitialized = false;
let currentPosition = null;
let watchPositionId = null;
let arContents = [];
let currentHeading = 0;
let targetARContent = null;
let cameraStream = null;
let arViewMode = 'realworld';
let openedBoxes = new Set();
let lastNearbyContent = [];
let animationFrameId = null;
let lastUpdateTime = 0;

const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3gcrsiBqijSgAqWi01ux417lYWx-JlMDlDeWI_qgrGU1FU7LKc5xL6xmKmGgSUj_UCucrug7M4ZBz/pub?gid=0&single=true&output=csv';

// init
window.addEventListener('load', initApp);

function initApp(){
    document.getElementById('loading-screen').classList.remove('hidden');
    loadCSVData();
    if(window.DeviceOrientationEvent){
        window.addEventListener('deviceorientationabsolute', (e)=>{ handleOrientation(e); });
    }
}

async function loadCSVData(){
    try{
        document.getElementById('loading-status').textContent = 'Mengambil data dari server...';
        const res = await fetch(csvUrl);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        document.getElementById('loading-status').textContent = 'Memproses konten AR...';
        parseCSV(txt);
        saveARContentsToStorage();
        setTimeout(()=>{
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('student-mode').classList.remove('hidden');
            currentMode = 'student';
            initStudentMode();
        },700);
    }catch(err){
        console.error('Error loading CSV',err);
        document.getElementById('loading-status').textContent = 'Gagal memuat data. Memuat konten offline jika ada...';
        loadARContents();
        setTimeout(()=>{
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('student-mode').classList.remove('hidden');
            currentMode = 'student';
            initStudentMode();
        },700);
    }
}

function parseCSV(csvText){
    const lines = csvText.trim().split('
');
    if(lines.length<2) return;
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const nameIndex = headers.findIndex(h=>h.includes('name')||h.includes('title')||h.includes('nama'));
    const latIndex = headers.findIndex(h=>h.includes('lat'));
    const lonIndex = headers.findIndex(h=>h.includes('lon')||h.includes('lng'));
    const urlIndex = headers.findIndex(h=>h.includes('url'));
    const descIndex = headers.findIndex(h=>h.includes('desc')||h.includes('description'));
    arContents = [];

    for(let i=1;i<lines.length;i++){
        const row = splitCsvLine(lines[i]);
        const name = (nameIndex>-1?row[nameIndex]:'Konten '+i) || ('Konten '+i);
        const lat = parseFloat(row[latIndex]);
        const lon = parseFloat(row[lonIndex]);
        const url = row[urlIndex] || '';
        const desc = descIndex>-1? (row[descIndex]||'') : '';
        if(!url || isNaN(lat) || isNaN(lon)) continue;

        let contentType = 'web';
        let processedContent = url.trim();

        if(/youtube.com|youtu.be/.test(url)){
            contentType = 'video';
            processedContent = extractYouTubeID(url);
        } else if(/\.glb($|\?|#)|\.gltf($|\?|#)/i.test(url)){
            contentType = '3d';
            processedContent = url.trim();
        } else if(url.includes(',') && url.split(',').length>1){
            contentType = 'presentation';
            processedContent = JSON.stringify(url.split(',').map(u=>u.trim()).filter(Boolean));
        } else if(/\.(jpg|jpeg|png|gif|webp)$/i.test(url)){
            contentType = 'image';
            processedContent = url.trim();
        }

        arContents.push({
            id:`csv_${i}_${Date.now()}`,
            title:name,
            type:contentType,
            content:processedContent,
            description:desc,
            lat:lat,
            lng:lon,
            radius:50,
            height:1.5,
            anchorType:'fixed',
            scale:1.0,
            rotation:0
        });
    }
}

function splitCsvLine(line){
    const parts=[]; let cur=''; let inQuotes=false;
    for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ inQuotes=!inQuotes; continue;} if(ch===',' && !inQuotes){ parts.push(cur); cur=''; } else cur+=ch; }
    parts.push(cur); return parts.map(p=>p.trim());
}

function extractYouTubeID(url){ if(/^[A-Za-z0-9_-]{11}$/.test(url)) return url; const m=url.match(/(?:youtu\.be\/|v\/|embed\/|watch\?v=|\&v=)([A-Za-z0-9_-]{11})/); return m?m[1]:url; }

function saveARContentsToStorage(){ localStorage.setItem('arContents',JSON.stringify(arContents)); }
function loadARContents(){ const s=localStorage.getItem('arContents'); if(s){ arContents=JSON.parse(s); updateARMarkers(); updateARContentList(); } }

/* ---------- Student Mode ---------- */
function initStudentMode(){ startCamera(); if(!studentMapInitialized){ studentMap = L.map('student-map').setView([0,0],18); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(studentMap); studentMapInitialized=true; document.getElementById('student-use-current-location').addEventListener('click',()=>{ if(currentPosition) studentMap.setView([currentPosition.lat,currentPosition.lng],18); }); }
    startLocationTracking(); startOrientationTracking(); loadOpenedBoxes(); startARRenderingLoop(); updateARMarkers(); updateARContentList(); }

/* Camera */
function startCamera(){ if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{ document.getElementById('camera-feed').srcObject=stream; cameraStream=stream; }).catch(e=>{ console.warn('camera error',e); alert('Tidak dapat mengakses kamera.'); }); } }
function stopCamera(){ if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; } }

/* Location */
function startLocationTracking(){ if(navigator.geolocation){ watchPositionId = navigator.geolocation.watchPosition(pos=>{ currentPosition={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy}; if(studentMap) { studentMap.setView([currentPosition.lat,currentPosition.lng],18); updateStudentMapMarkers(); } checkNearbyARContent(); }, err=>{ console.warn('loc err',err); }, {enableHighAccuracy:true,maximumAge:0,timeout:5000}); } }

/* Orientation */
let useAbsoluteHeading=false; function startOrientationTracking(){ if(window.DeviceOrientationEvent){ if(!useAbsoluteHeading) window.addEventListener('deviceorientation', handleOrientation); } }
function handleOrientation(event){ if(event.alpha!==null){ if(useAbsoluteHeading){ currentHeading = (360 - (event.alpha || 0)) % 360; } else { currentHeading = (event.alpha || 0) % 360; } const needle = document.getElementById('compass-needle'); if(needle) needle.style.transform = `rotate(${currentHeading}deg)`; updateDirectionArrow(); updateDebugInfo(); } }

function showCalibration(){ document.getElementById('calibration-overlay').classList.remove('hidden'); }
function finishCalibration(){ document.getElementById('calibration-overlay').classList.add('hidden'); }

/* Map markers */
function updateStudentMapMarkers(){ if(!studentMap || !currentPosition) return; studentMap.eachLayer(layer=>{ if(layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polyline) studentMap.removeLayer(layer); }); L.marker([currentPosition.lat,currentPosition.lng],{icon:L.divIcon({className:'current-position-marker',html:'<div style="width:12px;height:12px;border-radius:50%;background:#2563eb;border:2px solid #fff"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(studentMap); L.circle([currentPosition.lat,currentPosition.lng],{radius:currentPosition.accuracy,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:0.08,weight:1}).addTo(studentMap);
    arContents.forEach(content=>{ const marker = L.marker([content.lat,content.lng],{icon:L.divIcon({className:'ar-marker',html:`<div style="width:28px;height:28px;border-radius:50%;background:#4f46e5;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">${getContentTypeIcon(content.type)}</div>`,iconSize:[28,28],iconAnchor:[14,14]})}).addTo(studentMap); L.circle([content.lat,content.lng],{radius:content.radius,color:'#4f46e5',fillColor:'#4f46e5',fillOpacity:0.08,weight:1}).addTo(studentMap); marker.on('click',()=>{ targetARContent = content; updateDirectionArrow(); alert('Navigasi ke: '+content.title); toggleView('camera'); }); });
    if(targetARContent){ L.polyline([[currentPosition.lat,currentPosition.lng],[targetARContent.lat,targetARContent.lng]],{color:'#4f46e5',weight:3,dashArray:'5,10',opacity:0.8}).addTo(studentMap); }
}

function getContentTypeIcon(type){ switch(type){ case 'text': return 'T'; case 'image': return 'G'; case '3d': return '3D'; case 'video': return 'V'; case 'presentation': return 'P'; case 'web': return 'W'; default: return '?'; } }

/* Nearby detection */
function checkNearbyARContent(){ if(!currentPosition) return; let nearby=[]; let closestDist=Infinity; let closest=null; arContents.forEach(c=>{ c.distance = calculateDistance(currentPosition.lat,currentPosition.lng,c.lat,c.lng); if(c.distance <= c.radius) nearby.push(c); if(c.distance < closestDist){ closestDist = c.distance; closest = c; } }); const distEl=document.getElementById('distance-indicator'); if(closest){ distEl.textContent = `${closest.title}: ${Math.round(closest.distance)}m`; if(!targetARContent) targetARContent = closest; } else { distEl.textContent = 'Tidak ada konten AR terdekat'; }
    updateNearbyContentList(nearby); updateDebugInfo(); updateARObjects(nearby); lastNearbyContent = nearby;
}

/* AR Objects management */
let arObjects = [];
function updateARObjects(nearbyContent){ const overlay=document.getElementById('ar-overlay'); if(arViewMode==='indicator'){ overlay.innerHTML=''; nearbyContent.forEach(content=>{ const isOpened = openedBoxes.has(content.id); const canOpen = content.distance<=15; const indicator = document.createElement('div'); indicator.className='ar-indicator'; indicator.textContent = isOpened? content.title : (canOpen? 'üéÅ Buka Kotak' : 'üéÅ Kotak Misterius'); indicator.style.left = '50%'; indicator.style.top = '20%'; indicator.style.transform='translate(-50%,-50%)'; indicator.style.cursor='pointer'; indicator.addEventListener('click', ()=>{ if(!isOpened && canOpen) openTreasureBox(content.id); else if(isOpened) showARContent(content); else alert(`Dekati dalam 15m untuk buka kotak. Saat ini ${Math.round(content.distance)}m`); }); overlay.appendChild(indicator); }); } else { // real world, we'll create arObjects entries and let render loop place them
        // keep existing but remove ones not in nearbyContent
        const ids = nearbyContent.map(c=>c.id);
        arObjects = arObjects.filter(o=>ids.includes(o.id));
        nearbyContent.forEach(c=>{ if(!arObjects.find(o=>o.id===c.id)) arObjects.push({id:c.id,content:c,element:null}); });
    }
}

/* Render loop */
function startARRenderingLoop(){ function loop(){ const now = Date.now(); if(now - lastUpdateTime > 60){ renderARObjects(); lastUpdateTime = now; } animationFrameId = requestAnimationFrame(loop); } loop(); }

function renderARObjects(){ const overlay = document.getElementById('ar-overlay'); overlay.innerHTML = ''; if(!currentPosition) return; if(arViewMode==='indicator'){ // indicator already drawn in updateARObjects; nothing more here
        return; }
    arObjects.forEach(obj=>{ const content = obj.content; const bearing = calculateBearing(currentPosition.lat,currentPosition.lng,content.lat,content.lng); const relative = (bearing - currentHeading + 360) % 360; if(relative < 60 || relative > 300){ let viewportX; if(relative < 60) viewportX = 50 + (relative/60)*40; else viewportX = 50 - ((360 - relative)/60)*40; const viewportY = 50 - (content.height||1.5)*3; const el = document.createElement('div'); el.className='ar-object'; el.style.left = Math.max(8, Math.min(92, viewportX)) + '%'; el.style.top = Math.max(8, Math.min(80, viewportY)) + '%'; const isOpened = openedBoxes.has(content.id); const canOpen = content.distance <= 15; if(!isOpened){ const box = document.createElement('div'); box.className='treasure-box'; box.textContent='üîí'; box.addEventListener('click',(e)=>{ e.stopPropagation(); if(canOpen) openTreasureBox(content.id); else alert(`Dekati dalam 15m untuk buka kotak. Saat ini ${Math.round(content.distance)}m`); }); el.appendChild(box); } else { const contentEl = createContentElement(content); el.appendChild(contentEl); el.addEventListener('click',()=>{ showARContent(content); }); } overlay.appendChild(el); }
    }); }

/* create content element (3d, video, image, presentation, web) */
function createContentElement(content){ if(content.type==='3d'){ const wrap=document.createElement('div'); wrap.style.width='140px'; wrap.style.height='140px'; wrap.innerHTML = `<model-viewer src="${content.content}" alt="${content.title}" auto-rotate camera-controls style="width:100%;height:100%"></model-viewer>`; return wrap; }
    if(content.type==='video'){ const wrap=document.createElement('div'); wrap.className='ar-object-video'; const iframe=document.createElement('iframe'); iframe.src = `https://www.youtube.com/embed/${content.content}`; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen'; iframe.style.width='320px'; iframe.style.height='200px'; wrap.appendChild(iframe); return wrap; }
    if(content.type==='presentation'){ const slides = JSON.parse(content.content); const wrap=document.createElement('div'); wrap.className='ar-object-presentation'; const iframe=document.createElement('iframe'); iframe.src = slides[0]; iframe.style.width='100%'; iframe.style.height='100%'; wrap.appendChild(iframe); return wrap; }
    // default: web or image
    const wrapper = document.createElement('div'); wrapper.className='ar-object-presentation'; wrapper.style.width='320px'; wrapper.style.height='220px'; wrapper.style.position='relative'; const iframe = document.createElement('iframe'); iframe.src = content.content; iframe.loading='lazy'; iframe.style.width='100%'; iframe.style.height='100%';
    const topBar = document.createElement('div'); topBar.style.position='absolute'; topBar.style.top='6px'; topBar.style.left='8px'; topBar.style.right='8px'; topBar.style.display='flex'; topBar.style.justifyContent='space-between'; topBar.style.alignItems='center'; topBar.style.pointerEvents='none'; const title = document.createElement('div'); title.textContent = content.title || 'Buka Berita'; title.style.fontSize='12px'; title.style.fontWeight='600'; title.style.background='rgba(255,255,255,0.9)'; title.style.padding='4px 8px'; title.style.borderRadius='6px'; title.style.pointerEvents='auto'; const openBtn = document.createElement('button'); openBtn.textContent='Buka di tab baru'; openBtn.style.pointerEvents='auto'; openBtn.style.fontSize='12px'; openBtn.style.padding='6px 8px'; openBtn.style.borderRadius='8px'; openBtn.style.border='none'; openBtn.style.cursor='pointer'; openBtn.style.background='#3b82f6'; openBtn.style.color='#fff'; openBtn.addEventListener('click',(e)=>{ e.stopPropagation(); window.open(content.content,'_blank'); }); topBar.appendChild(title); topBar.appendChild(openBtn); const hint = document.createElement('div'); hint.textContent='Jika kosong/terblokir, klik "Buka di tab baru".'; hint.style.position='absolute'; hint.style.bottom='6px'; hint.style.left='8px'; hint.style.fontSize='11px'; hint.style.background='rgba(255,255,255,0.9)'; hint.style.padding='4px 8px'; hint.style.borderRadius='6px'; hint.style.pointerEvents='none'; iframe.addEventListener('error',()=>{ hint.textContent = 'Tidak dapat menampilkan di dalam aplikasi ‚Äî silakan buka di tab baru.'; }); wrapper.appendChild(iframe); wrapper.appendChild(topBar); wrapper.appendChild(hint); return wrapper; }

/* Show full content modal */
function showARContent(content){ const existing = document.getElementById('ar-full-modal'); if(existing) existing.remove(); const modal = document.createElement('div'); modal.id='ar-full-modal'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.6)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='99999'; const card=document.createElement('div'); card.style.width='90%'; card.style.maxWidth='1100px'; card.style.height='85%'; card.style.background='#fff'; card.style.borderRadius='12px'; card.style.overflow='hidden'; card.style.position='relative'; const closeBtn=document.createElement('button'); closeBtn.textContent='‚úï'; closeBtn.style.position='absolute'; closeBtn.style.right='12px'; closeBtn.style.top='12px'; closeBtn.style.zIndex='9999'; closeBtn.addEventListener('click',()=>{ modal.remove(); }); const contentEl = createContentElement(content); contentEl.style.width='100%'; contentEl.style.height='100%'; card.appendChild(closeBtn); card.appendChild(contentEl); modal.appendChild(card); document.body.appendChild(modal); }

/* Open treasure box */
function openTreasureBox(id){ openedBoxes.add(id); saveOpenedBoxes(); alert('Kotak dibuka!'); // optionally show content
    const c = arContents.find(x=>x.id===id); if(c) showARContent(c);
}

function saveOpenedBoxes(){ localStorage.setItem('openedBoxes',JSON.stringify(Array.from(openedBoxes))); }
function loadOpenedBoxes(){ const s=localStorage.getItem('openedBoxes'); if(s) openedBoxes=new Set(JSON.parse(s)); }

/* Nearby list */
function updateNearbyContentList(contents){ const list = document.getElementById('nearby-content-list'); list.innerHTML=''; if(!contents || contents.length===0){ list.innerHTML = '<div class="text-center py-8 text-gray-500">Tidak ada konten AR terdekat</div>'; return; } contents.sort((a,b)=>(a.distance||0)-(b.distance||0)); contents.forEach(c=>{ const row=document.createElement('div'); row.className='p-3 border-b'; row.innerHTML = `<div style="font-weight:600">${c.title}</div><div style="font-size:13px;color:#6b7280">${Math.round(c.distance||0)}m</div>`; row.addEventListener('click',()=>{ showARContent(c); }); list.appendChild(row); }); }

function updateARContentList(){ /* placeholder if needed elsewhere */ }

/* Utility: calc distance & bearing */
function calculateDistance(lat1,lon1,lat2,lon2){ const R=6371e3; const œÜ1=lat1*Math.PI/180; const œÜ2=lat2*Math.PI/180; const ŒîœÜ=(lat2-lat1)*Math.PI/180; const ŒîŒª=(lon2-lon1)*Math.PI/180; const a=Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }
function calculateBearing(lat1,lon1,lat2,lon2){ const œÜ1=lat1*Math.PI/180; const œÜ2=lat2*Math.PI/180; const ŒîŒª=(lon2-lon1)*Math.PI/180; const y=Math.sin(ŒîŒª)*Math.cos(œÜ2); const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª); let br = Math.atan2(y,x)*180/Math.PI; br = (br+360)%360; return br; }

/* Direction arrow & debug */
function updateDirectionArrow(){ if(!currentPosition || !targetARContent) return; const bearing = calculateBearing(currentPosition.lat,currentPosition.lng,targetARContent.lat,targetARContent.lng); const relative = (bearing - currentHeading + 360) % 360; const arrow=document.getElementById('arrow'); if(arrow) arrow.style.transform = `rotate(${relative-45}deg)`; updateDebugInfo(); }
function updateDebugInfo(){ const el=document.getElementById('debug-info'); if(!el) return; let txt=`Arah: ${Math.round(currentHeading)}¬∞`; if(targetARContent){ txt += `<br>Target: ${targetARContent.title}`; txt += `<br>Bearing: ${Math.round(calculateBearing(currentPosition.lat,currentPosition.lng,targetARContent.lat,targetARContent.lng))}¬∞`; txt += `<br>Jarak: ${Math.round(targetARContent.distance||0)}m`; } else { txt += '<br>Target: N/A'; } el.innerHTML = txt; }

function toggleDebugInfo(){ const el=document.getElementById('debug-info'); el.classList.toggle('hidden'); }

/* Toggle AR view mode */
function toggleARViewMode(){ arViewMode = (arViewMode==='realworld')? 'indicator' : 'realworld'; document.getElementById('ar-view-mode-text').textContent = (arViewMode==='realworld')? 'Tampilan AR: Dunia Nyata' : 'Tampilan AR: Indikator'; updateARObjects(lastNearbyContent); }

/* Nearby list UI */
function showContentList(){ document.getElementById('content-list-modal').classList.remove('hidden'); updateNearbyContentList(lastNearbyContent.length?lastNearbyContent:arContents); }
function hideContentList(){ document.getElementById('content-list-modal').classList.add('hidden'); }

/* Map toggle */
function toggleView(v){ if(v==='map'){ document.getElementById('camera-view').classList.add('hidden'); document.getElementById('map-view').classList.remove('hidden'); if(studentMap) studentMap.invalidateSize(); } else { document.getElementById('map-view').classList.add('hidden'); document.getElementById('camera-view').classList.remove('hidden'); } }

/* helper: update markers (calls student map update) */
function updateARMarkers(){ if(studentMapInitialized && currentPosition) updateStudentMapMarkers(); }

/* Start orientation tracking (fallback) */
function startOrientationTracking(){ if(window.DeviceOrientationEvent){ window.addEventListener('deviceorientation', handleOrientation); } }

// get current location once
function getCurrentLocation(centerMap=false){ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{ currentPosition={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy}; if(centerMap && studentMap) studentMap.setView([currentPosition.lat,currentPosition.lng],18); checkNearbyARContent(); }, err=>{ console.warn('getCurrentLocation err',err); alert('Tidak dapat mendapatkan lokasi Anda. Pastikan GPS aktif.'); }, {enableHighAccuracy:true,timeout:10000}); } }

/* start location tracking for map */
function startLocationTracking(){ if(navigator.geolocation){ watchPositionId = navigator.geolocation.watchPosition(pos=>{ currentPosition={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy}; if(studentMap) { studentMap.setView([currentPosition.lat,currentPosition.lng],18); updateStudentMapMarkers(); } checkNearbyARContent(); }, err=>{ console.warn(err); }, {enableHighAccuracy:true,maximumAge:0,timeout:5000}); } }

/* Camera start/stop already above */

/* Utility: try to open iframe target - note many sites block framing */
function canIFrameDomain(url){ try{ const u=new URL(url); const blockedDomains = ['detik.com','kompas.com','tribunnews.com']; return !blockedDomains.includes(u.hostname.replace('www.','')); }catch(e){ return true; } }

/* cleanup on unload */
window.addEventListener('beforeunload', ()=>{ if(watchPositionId) navigator.geolocation.clearWatch(watchPositionId); if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop()); });

</script>
</body>
</html>
